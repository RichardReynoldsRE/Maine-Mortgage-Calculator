<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mortgage Calculator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #fafbfc;
            min-height: 100vh;
            padding: 20px;
            color: #0f172a;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1280px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 48px;
            padding: 60px 20px 40px;
        }
        
        h1 {
            color: #0f172a;
            margin-bottom: 12px;
            font-size: 3em;
            font-weight: 700;
            letter-spacing: -1.5px;
        }
        
        .subtitle {
            color: #64748b;
            font-size: 1.125rem;
            font-weight: 400;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .section {
            background: white;
            padding: 32px;
            border-radius: 12px;
            margin-bottom: 24px;
            border: 1px solid #e2e8f0;
            transition: box-shadow 0.2s;
        }
        
        .section:hover {
            box-shadow: 0 1px 3px rgba(0,0,0,0.04), 0 4px 12px rgba(0,0,0,0.04);
        }
        
        .section-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #0f172a;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            font-weight: 500;
            color: #0f172a;
            margin-bottom: 8px;
            font-size: 0.875rem;
        }
        
        .help-text {
            font-size: 0.8125rem;
            color: #64748b;
            margin-top: 6px;
            line-height: 1.5;
        }
        
        input[type="number"], input[type="date"], select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 0.9375rem;
            transition: all 0.15s ease;
            background: white;
            color: #0f172a;
        }
        
        input[type="number"]:focus, input[type="date"]:focus, select:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.08);
        }
        
        input[type="number"]:hover, input[type="date"]:hover, select:hover {
            border-color: #94a3b8;
        }
        
        .button-bar {
            display: flex;
            gap: 12px;
            margin: 32px 0;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 0.9375rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }
        
        .btn-calculate {
            background: #2563eb;
            color: white;
            padding: 14px 32px;
            font-size: 1rem;
            font-weight: 600;
        }
        
        .btn-calculate:hover {
            background: #1d4ed8;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
        }
        
        .btn-calculate:active {
            transform: translateY(1px);
        }
        
        .btn-save {
            background: white;
            color: #0f172a;
            border: 1px solid #cbd5e1;
        }
        
        .btn-save:hover {
            background: #f8fafc;
            border-color: #94a3b8;
        }
        
        .btn-load {
            background: white;
            color: #0f172a;
            border: 1px solid #cbd5e1;
            position: relative;
            overflow: hidden;
        }
        
        .btn-load:hover {
            background: #f8fafc;
            border-color: #94a3b8;
        }
        
        .btn-load input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        
        .results-highlight {
            background: white;
            padding: 40px;
            border-radius: 12px;
            margin-bottom: 24px;
            border: 1px solid #e2e8f0;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 24px;
        }
        
        .result-item {
            padding: 24px;
            border-radius: 12px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            transition: all 0.2s;
        }
        
        .result-item:hover {
            background: white;
            border-color: #cbd5e1;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }
        
        .result-label {
            font-size: 0.8125rem;
            color: #64748b;
            margin-bottom: 8px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .result-value {
            font-size: 2rem;
            font-weight: 700;
            color: #0f172a;
            letter-spacing: -1px;
            margin-bottom: 4px;
        }
        
        .result-detail {
            font-size: 0.8125rem;
            color: #64748b;
            font-weight: 400;
        }
        
        #monthlyBreakdown {
            background: #fafbfc;
            border-radius: 8px;
            padding: 0;
            overflow: hidden;
        }
        
        .breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            border-bottom: 1px solid #e2e8f0;
            transition: background 0.15s;
        }
        
        .breakdown-item:hover {
            background: white;
        }
        
        .breakdown-item:last-child {
            border-bottom: none;
        }
        
        .breakdown-label {
            font-weight: 500;
            color: #475569;
            font-size: 0.9375rem;
        }
        
        .breakdown-value {
            font-weight: 600;
            color: #0f172a;
            font-size: 1rem;
            font-variant-numeric: tabular-nums;
        }
        
        .breakdown-total {
            background: #0f172a;
            color: white;
            padding: 20px 24px;
            margin: 0;
        }
        
        .affordability-meter {
            padding: 24px;
        }
        
        .meter-bar {
            height: 8px;
            background: #e2e8f0;
            border-radius: 100px;
            overflow: hidden;
            margin: 16px 0;
            position: relative;
        }
        
        .meter-fill {
            height: 100%;
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1), background 0.3s;
            border-radius: 100px;
        }
        
        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: #64748b;
            font-weight: 500;
            margin-top: 8px;
        }
        
        .chart-container {
            background: white;
            padding: 32px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            margin-top: 24px;
        }
        
        .table-wrapper {
            overflow-x: auto;
            margin-top: 24px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        th {
            background: #f8fafc;
            color: #475569;
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            font-size: 0.8125rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        th:first-child {
            border-radius: 12px 0 0 0;
        }
        
        th:last-child {
            border-radius: 0 12px 0 0;
        }
        
        td {
            padding: 12px 16px;
            border-bottom: 1px solid #f1f5f9;
            color: #0f172a;
            font-size: 0.875rem;
            font-variant-numeric: tabular-nums;
        }
        
        tbody tr:hover {
            background: #fafbfc;
        }
        
        tbody tr:last-child td {
            border-bottom: none;
        }
        
        .info-box {
            background: #eff6ff;
            border-left: 3px solid #2563eb;
            padding: 16px 20px;
            border-radius: 8px;
            margin: 20px 0;
            font-size: 0.9375rem;
            line-height: 1.6;
        }
        
        .info-box strong {
            color: #1e40af;
            font-weight: 600;
        }
        
        /* Comparison cards */
        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .comparison-card {
            background: #f8fafc;
            padding: 24px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }
        
        .comparison-card.success {
            background: #f0fdf4;
            border-color: #bbf7d0;
        }
        
        .comparison-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #0f172a;
            margin-bottom: 16px;
        }
        
        .comparison-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .comparison-item:last-child {
            border-bottom: none;
        }
        
        .comparison-label {
            color: #64748b;
            font-size: 0.9375rem;
        }
        
        .comparison-value {
            font-weight: 600;
            color: #0f172a;
            font-variant-numeric: tabular-nums;
        }
        
        .savings-highlight {
            background: #22c55e;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            text-align: center;
            margin-top: 16px;
            font-weight: 600;
            font-size: 0.9375rem;
        }
        
        .success-box {
            background: #f0fdf4;
            border-left: 3px solid #22c55e;
            padding: 20px;
            border-radius: 8px;
            margin-top: 16px;
            font-size: 0.9375rem;
            line-height: 1.6;
        }
        
        /* Closing costs */
        .cost-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .cost-row:last-child {
            border-bottom: none;
        }
        
        .cost-label {
            color: #64748b;
            font-size: 0.9375rem;
        }
        
        .cost-value {
            font-weight: 600;
            color: #0f172a;
            font-variant-numeric: tabular-nums;
        }
        
        .cost-total {
            background: #f8fafc;
            padding: 16px !important;
            border-radius: 8px;
            margin-top: 12px;
            font-weight: 700;
            font-size: 1rem;
            border: 1px solid #e2e8f0;
        }
        
        /* Status badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 100px;
            font-size: 0.8125rem;
            font-weight: 500;
        }
        
        .status-good {
            background: #dcfce7;
            color: #166534;
        }
        
        .status-warning {
            background: #fef3c7;
            color: #92400e;
        }
        
        .status-alert {
            background: #fee2e2;
            color: #991b1b;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 0;
            }
            
            .header {
                padding: 40px 20px 32px;
            }
            
            h1 {
                font-size: 2rem;
                letter-spacing: -1px;
            }
            
            .subtitle {
                font-size: 1rem;
            }
            
            .section {
                padding: 24px;
                border-radius: 0;
                border-left: none;
                border-right: none;
                margin-bottom: 0;
            }
            
            .input-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .results-grid {
                grid-template-columns: 1fr;
            }
            
            .button-bar {
                flex-direction: column;
                padding: 0 20px;
            }
            
            button {
                width: 100%;
                justify-content: center;
            }
            
            .result-value {
                font-size: 1.75rem;
            }
        }
        
        /* Smooth scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 100px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        /* Smooth animations */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        #results {
            animation: slideIn 0.3s ease-out;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Mortgage Calculator</h1>
            <p class="subtitle">Get accurate payment estimates and detailed loan insights to make smarter homebuying decisions</p>
        </div>
        
        <div class="section">
            <div class="section-title">Property Details</div>
            <div class="input-grid">
                <div class="input-group">
                    <label for="loanType">Loan Type</label>
                    <select id="loanType" onchange="updateLoanTypeInfo()">
                        <option value="conventional">Conventional Loan</option>
                        <option value="fha">FHA Loan</option>
                        <option value="va">VA Loan</option>
                        <option value="usda">USDA Loan</option>
                    </select>
                    <div class="help-text" id="loanTypeInfo">Most common type. Requires PMI if down payment is less than 20%.</div>
                </div>
                
                <div class="input-group">
                    <label for="closingDate">Estimated Closing Date</label>
                    <input type="date" id="closingDate" value="">
                    <div class="help-text">When you expect to close on the property</div>
                </div>
                
                <div class="input-group">
                    <label for="homePrice">Home Price ($)</label>
                    <input type="number" id="homePrice" value="300000" min="0" step="1000" oninput="updateDownPaymentPercent()">
                    <div class="help-text">Purchase price of the property</div>
                </div>
                
                <div class="input-group">
                    <label for="downPayment">Down Payment ($)</label>
                    <input type="number" id="downPayment" value="60000" min="0" step="1000" oninput="updateDownPaymentPercent()">
                    <div class="help-text" id="downPaymentPercent">20.0% down payment</div>
                </div>
            </div>
        </div>
        
        <div class="section">
            <div class="section-title">Loan Terms</div>
            <div class="input-grid">
                <div class="input-group">
                    <label for="interestRate">Interest Rate (%)</label>
                    <input type="number" id="interestRate" value="6.5" min="0" max="20" step="0.01">
                    <div class="help-text">Annual interest rate for the loan</div>
                </div>
                
                <div class="input-group">
                    <label for="loanTerm">Loan Term (years)</label>
                    <select id="loanTerm">
                        <option value="30">30 years</option>
                        <option value="20">20 years</option>
                        <option value="15">15 years</option>
                        <option value="10">10 years</option>
                    </select>
                    <div class="help-text">Length of the mortgage</div>
                </div>
                
                <div class="input-group">
                    <label for="pmiRate">PMI/MIP Rate (% annually)</label>
                    <input type="number" id="pmiRate" value="0.5" min="0" max="2" step="0.05">
                    <div class="help-text">Private Mortgage Insurance (if applicable)</div>
                </div>
            </div>
        </div>
        
        <div class="section">
            <div class="section-title">Additional Costs</div>
            <div class="input-grid">
                <div class="input-group">
                    <label for="propertyTax">Annual Property Tax ($)</label>
                    <input type="number" id="propertyTax" value="3000" min="0" step="100">
                    <div class="help-text">Yearly property tax amount</div>
                </div>
                
                <div class="input-group">
                    <label for="homeInsurance">Annual Home Insurance ($)</label>
                    <input type="number" id="homeInsurance" value="1200" min="0" step="100">
                    <div class="help-text">Yearly homeowners insurance premium</div>
                </div>
                
                <div class="input-group">
                    <label for="hoaFees">Monthly HOA Fees ($)</label>
                    <input type="number" id="hoaFees" value="0" min="0" step="10">
                    <div class="help-text">Homeowners Association fees</div>
                </div>
            </div>
        </div>
        
        <div class="section">
            <div class="section-title">Extra Payments (Optional)</div>
            <div class="input-grid">
                <div class="input-group">
                    <label for="extraMonthly">Extra Monthly Payment ($)</label>
                    <input type="number" id="extraMonthly" value="0" min="0" step="10">
                    <div class="help-text">Additional amount paid each month toward principal</div>
                </div>
                
                <div class="input-group">
                    <label for="extraYearly">Extra Yearly Payment ($)</label>
                    <input type="number" id="extraYearly" value="0" min="0" step="100">
                    <div class="help-text">Additional lump sum paid once per year</div>
                </div>
                
                <div class="input-group">
                    <label for="householdIncome">Annual Household Income ($)</label>
                    <input type="number" id="householdIncome" value="0" min="0" step="1000">
                    <div class="help-text">For affordability assessment (optional)</div>
                </div>
            </div>
        </div>
        
        <div class="button-bar">
            <button class="btn-calculate" onclick="calculate()">Calculate Payment</button>
            <button class="btn-save" onclick="saveCalculation()">Save Calculation</button>
            <button class="btn-load">
                Load Calculation
                <input type="file" accept=".json" onchange="loadCalculation(event)">
            </button>
        </div>
        
        <div id="results" style="display: none;">
            <div class="results-highlight">
                <div class="results-grid">
                    <div class="result-item">
                        <div class="result-label">Monthly Payment</div>
                        <div class="result-value" id="totalMonthly">$0</div>
                        <div class="result-detail">Principal & Interest</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">With Taxes & Insurance</div>
                        <div class="result-value" id="totalWithTaxes">$0</div>
                        <div class="result-detail">Complete monthly cost</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Total Interest</div>
                        <div class="result-value" id="totalInterest">$0</div>
                        <div class="result-detail">Over life of loan</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Loan Amount</div>
                        <div class="result-value" id="loanAmount">$0</div>
                        <div class="result-detail">Principal borrowed</div>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <div class="section-title">Monthly Payment Breakdown</div>
                <div id="monthlyBreakdown"></div>
            </div>
            
            <div class="section" id="affordabilitySection" style="display: none;">
                <div class="section-title">Affordability Analysis</div>
                <div class="affordability-meter">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <div style="font-weight: 600; font-size: 1rem; color: #0f172a;">Housing Expense Ratio</div>
                        <div id="affordabilityPercent" style="font-weight: 700; font-size: 1.25rem; color: #2563eb;">0%</div>
                    </div>
                    <div class="meter-bar">
                        <div class="meter-fill" id="affordabilityFill"></div>
                    </div>
                    <div class="meter-labels">
                        <span>0%</span>
                        <span style="color: #22c55e; font-weight: 600;">28% Recommended</span>
                        <span>50%+</span>
                    </div>
                    <div class="info-box" id="affordabilityMessage"></div>
                </div>
            </div>
            
            <div id="fiveYearSection"></div>
            
            <div id="loanComparisonSection"></div>
            
            <div class="section" id="closingCostsContainer">
                <div id="closingCostsSection"></div>
            </div>
            
            <div class="chart-container">
                <div class="section-title">Principal vs Interest Over Time</div>
                <canvas id="paymentChart" width="400" height="200"></canvas>
            </div>
            
            <div class="section">
                <div class="section-title">Amortization Schedule</div>
                <div class="table-wrapper">
                    <table id="scheduleTable">
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th>Payment</th>
                                <th>Principal</th>
                                <th>Interest</th>
                                <th>PMI/MIP</th>
                                <th>Balance</th>
                            </tr>
                        </thead>
                        <tbody id="scheduleBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Set today's date as default closing date
        document.getElementById('closingDate').value = new Date().toISOString().split('T')[0];
        
        function updateDownPaymentPercent() {
            const homePrice = parseFloat(document.getElementById('homePrice').value) || 0;
            const downPayment = parseFloat(document.getElementById('downPayment').value) || 0;
            const percent = homePrice > 0 ? ((downPayment / homePrice) * 100).toFixed(1) : 0;
            document.getElementById('downPaymentPercent').textContent = percent + '% down payment';
        }
        
        function updateLoanTypeInfo() {
            const loanType = document.getElementById('loanType').value;
            const infoElement = document.getElementById('loanTypeInfo');
            
            const info = {
                conventional: 'Most common type. Requires PMI if down payment is less than 20%.',
                fha: 'FHA loans require as little as 3.5% down. MIP required for life of loan in most cases.',
                va: 'VA loans for veterans and active military. No down payment required. No PMI.',
                usda: 'USDA loans for rural properties. No down payment required. Annual fee applies.'
            };
            
            infoElement.textContent = info[loanType];
        }
        
        function formatCurrency(value) {
            return '$' + Math.round(value).toLocaleString('en-US');
        }
        
        function calculate() {
            const homePrice = parseFloat(document.getElementById('homePrice').value);
            const downPayment = parseFloat(document.getElementById('downPayment').value);
            const interestRate = parseFloat(document.getElementById('interestRate').value) / 100;
            const loanTerm = parseInt(document.getElementById('loanTerm').value);
            const propertyTax = parseFloat(document.getElementById('propertyTax').value);
            const homeInsurance = parseFloat(document.getElementById('homeInsurance').value);
            const hoaFees = parseFloat(document.getElementById('hoaFees').value);
            const pmiRate = parseFloat(document.getElementById('pmiRate').value) / 100;
            const extraMonthly = parseFloat(document.getElementById('extraMonthly').value) || 0;
            const extraYearly = parseFloat(document.getElementById('extraYearly').value) || 0;
            const householdIncome = parseFloat(document.getElementById('householdIncome').value) || 0;
            const loanType = document.getElementById('loanType').value;
            
            const principal = homePrice - downPayment;
            const monthlyRate = interestRate / 12;
            const numPayments = loanTerm * 12;
            
            // Calculate base monthly payment (P&I)
            const monthlyPayment = principal * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / 
                                 (Math.pow(1 + monthlyRate, numPayments) - 1);
            
            // Calculate PMI/MIP
            let pmiPayment = 0;
            const downPaymentPercent = (downPayment / homePrice) * 100;
            
            if (loanType === 'conventional' && downPaymentPercent < 20) {
                pmiPayment = (principal * pmiRate) / 12;
            } else if (loanType === 'fha') {
                pmiPayment = (principal * pmiRate) / 12;
            } else if (loanType === 'usda') {
                pmiPayment = (principal * 0.0035) / 12; // USDA annual fee
            }
            // VA loans have no PMI
            
            // Monthly additions
            const monthlyTax = propertyTax / 12;
            const monthlyInsurance = homeInsurance / 12;
            
            const totalMonthly = monthlyPayment + pmiPayment;
            const totalWithExtras = totalMonthly + monthlyTax + monthlyInsurance + hoaFees;
            
            // Display results
            document.getElementById('totalMonthly').textContent = formatCurrency(monthlyPayment);
            document.getElementById('totalWithTaxes').textContent = formatCurrency(totalWithExtras);
            document.getElementById('loanAmount').textContent = formatCurrency(principal);
            
            // Calculate amortization schedule with extra payments
            const schedule = calculateAmortization(principal, monthlyRate, numPayments, monthlyPayment, 
                                                   pmiPayment, extraMonthly, extraYearly, downPaymentPercent, loanType);
            
            const totalInterest = schedule.reduce((sum, payment) => sum + payment.interest, 0);
            document.getElementById('totalInterest').textContent = formatCurrency(totalInterest);
            
            // Display monthly breakdown
            displayMonthlyBreakdown(monthlyPayment, pmiPayment, monthlyTax, monthlyInsurance, hoaFees);
            
            // Display affordability if income provided
            if (householdIncome > 0) {
                displayAffordability(totalWithExtras, householdIncome);
            } else {
                document.getElementById('affordabilitySection').style.display = 'none';
            }
            
            // Display chart
            displayChart(schedule);
            
            // Display amortization schedule
            displaySchedule(schedule);
            
            // Display the three additional sections
            displayFiveYearTip(principal, monthlyRate, numPayments, monthlyPayment, totalInterest, extraMonthly, extraYearly);
            compare15vs30(homePrice, downPayment, interestRate, propertyTax, homeInsurance, hoaFees, pmiRate, loanType);
            calculateClosingCosts(principal, homePrice, propertyTax, homeInsurance, downPayment, loanType);
            
            document.getElementById('results').style.display = 'block';
        }
        
        function calculateAmortization(principal, monthlyRate, numPayments, monthlyPayment, pmiPayment, extraMonthly, extraYearly, downPaymentPercent, loanType) {
            const schedule = [];
            let balance = principal;
            let month = 0;
            
            while (balance > 0.01 && month < numPayments * 2) {
                month++;
                
                const interestPayment = balance * monthlyRate;
                let principalPayment = monthlyPayment - interestPayment;
                
                // Add extra payments
                principalPayment += extraMonthly;
                if (month % 12 === 0) {
                    principalPayment += extraYearly;
                }
                
                // Don't overpay
                if (principalPayment > balance) {
                    principalPayment = balance;
                }
                
                balance -= principalPayment;
                
                // Calculate PMI for this month
                let currentPmi = pmiPayment;
                let pmiRemoved = false;
                
                // PMI removal logic
                if (loanType === 'conventional') {
                    const currentLTV = (balance / (principal / (1 - downPaymentPercent / 100))) * 100;
                    if (currentLTV <= 78) {
                        currentPmi = 0;
                        pmiRemoved = true;
                    }
                }
                
                schedule.push({
                    month: month,
                    payment: monthlyPayment,
                    principal: principalPayment,
                    interest: interestPayment,
                    pmi: currentPmi,
                    pmiRemoved: pmiRemoved,
                    balance: balance
                });
                
                if (balance <= 0.01) break;
            }
            
            return schedule;
        }
        
        function displayMonthlyBreakdown(payment, pmi, tax, insurance, hoa) {
            const breakdown = document.getElementById('monthlyBreakdown');
            const items = [
                { label: 'Principal & Interest', value: payment },
                { label: 'Property Tax', value: tax },
                { label: 'Home Insurance', value: insurance },
                { label: 'HOA Fees', value: hoa }
            ];
            
            if (pmi > 0) {
                items.splice(1, 0, { label: 'PMI/MIP', value: pmi });
            }
            
            let html = '';
            let total = 0;
            
            items.forEach(item => {
                if (item.value > 0 || item.label === 'Principal & Interest') {
                    html += `
                        <div class="breakdown-item">
                            <span class="breakdown-label">${item.label}</span>
                            <span class="breakdown-value">${formatCurrency(item.value)}</span>
                        </div>
                    `;
                    total += item.value;
                }
            });
            
            html += `
                <div class="breakdown-total">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 1rem; font-weight: 600;">Total Monthly Payment</span>
                        <span style="font-size: 1.5rem; font-weight: 700;">${formatCurrency(total)}</span>
                    </div>
                </div>
            `;
            
            breakdown.innerHTML = html;
        }
        
        function displayAffordability(monthlyPayment, income) {
            const monthlyIncome = income / 12;
            const ratio = (monthlyPayment / monthlyIncome) * 100;
            
            document.getElementById('affordabilitySection').style.display = 'block';
            
            const fill = document.getElementById('affordabilityFill');
            const percentDisplay = document.getElementById('affordabilityPercent');
            fill.style.width = Math.min(ratio, 100) + '%';
            percentDisplay.textContent = ratio.toFixed(1) + '%';
            
            let color, message, badgeClass, badgeText;
            if (ratio <= 28) {
                color = '#22c55e';
                badgeClass = 'status-good';
                badgeText = 'Excellent';
                percentDisplay.style.color = '#22c55e';
                message = '<span class="status-badge status-good">' + badgeText + '</span> Your housing costs are within the recommended 28% of gross income. This leaves room in your budget for other expenses and savings.';
            } else if (ratio <= 36) {
                color = '#f59e0b';
                badgeClass = 'status-warning';
                badgeText = 'Moderate';
                percentDisplay.style.color = '#f59e0b';
                message = '<span class="status-badge status-warning">' + badgeText + '</span> Your housing costs are above 28% but still manageable. Consider your other debts and monthly obligations carefully.';
            } else {
                color = '#ef4444';
                badgeClass = 'status-alert';
                badgeText = 'High Risk';
                percentDisplay.style.color = '#ef4444';
                message = '<span class="status-badge status-alert">' + badgeText + '</span> Your housing costs exceed 36% of income. This may strain your budget significantly. Consider a lower price range or increasing your down payment.';
            }
            
            fill.style.background = color;
            document.getElementById('affordabilityMessage').innerHTML = message;
        }
        
        function displayChart(schedule) {
            const canvas = document.getElementById('paymentChart');
            const ctx = canvas.getContext('2d');
            
            // Set canvas size
            canvas.width = canvas.offsetWidth;
            canvas.height = 300;
            
            const width = canvas.width;
            const height = canvas.height;
            const padding = 60;
            
            ctx.clearRect(0, 0, width, height);
            
            // Sample data points (every 12 months)
            const dataPoints = schedule.filter((_, i) => i % 12 === 0 || i === schedule.length - 1);
            const maxPayment = Math.max(...dataPoints.map(p => p.payment));
            
            // Draw axes
            ctx.strokeStyle = '#cbd5e1';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, height - padding);
            ctx.lineTo(width - padding, height - padding);
            ctx.stroke();
            
            // Draw grid lines
            ctx.strokeStyle = '#f1f5f9';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 5; i++) {
                const y = padding + (height - 2 * padding) * i / 5;
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(width - padding, y);
                ctx.stroke();
            }
            
            // Calculate scales
            const xScale = (width - 2 * padding) / (dataPoints.length - 1);
            const yScale = (height - 2 * padding) / maxPayment;
            
            // Draw principal area
            ctx.fillStyle = 'rgba(37, 99, 235, 0.1)';
            ctx.beginPath();
            ctx.moveTo(padding, height - padding);
            dataPoints.forEach((point, i) => {
                const x = padding + i * xScale;
                const y = height - padding - point.principal * yScale;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.lineTo(width - padding, height - padding);
            ctx.closePath();
            ctx.fill();
            
            // Draw interest area
            ctx.fillStyle = 'rgba(99, 102, 241, 0.1)';
            ctx.beginPath();
            dataPoints.forEach((point, i) => {
                const x = padding + i * xScale;
                const yPrincipal = height - padding - point.principal * yScale;
                const yTotal = yPrincipal - point.interest * yScale;
                if (i === 0) ctx.moveTo(x, yPrincipal);
                else ctx.lineTo(x, yPrincipal);
            });
            for (let i = dataPoints.length - 1; i >= 0; i--) {
                const x = padding + i * xScale;
                const yPrincipal = height - padding - dataPoints[i].principal * yScale;
                const yTotal = yPrincipal - dataPoints[i].interest * yScale;
                ctx.lineTo(x, yTotal);
            }
            ctx.closePath();
            ctx.fill();
            
            // Draw principal line
            ctx.strokeStyle = '#2563eb';
            ctx.lineWidth = 2.5;
            ctx.beginPath();
            dataPoints.forEach((point, i) => {
                const x = padding + i * xScale;
                const y = height - padding - point.principal * yScale;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.stroke();
            
            // Draw interest line
            ctx.strokeStyle = '#6366f1';
            ctx.lineWidth = 2.5;
            ctx.beginPath();
            dataPoints.forEach((point, i) => {
                const x = padding + i * xScale;
                const yPrincipal = height - padding - point.principal * yScale;
                const y = yPrincipal - point.interest * yScale;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.stroke();
            
            // Draw labels
            ctx.fillStyle = '#0f172a';
            ctx.font = '12px -apple-system, BlinkMacSystemFont, sans-serif';
            ctx.textAlign = 'center';
            
            // X-axis labels
            const labelStep = Math.ceil(dataPoints.length / 6);
            dataPoints.forEach((point, i) => {
                if (i % labelStep === 0 || i === dataPoints.length - 1) {
                    const x = padding + i * xScale;
                    ctx.fillText('Year ' + Math.ceil(point.month / 12), x, height - padding + 25);
                }
            });
            
            // Y-axis labels
            ctx.textAlign = 'right';
            for (let i = 0; i <= 5; i++) {
                const y = padding + (height - 2 * padding) * (5 - i) / 5;
                const value = (maxPayment * i / 5);
                ctx.fillText(formatCurrency(value), padding - 10, y + 5);
            }
            
            // Legend
            ctx.textAlign = 'left';
            ctx.fillStyle = '#2563eb';
            ctx.fillRect(width - 200, 30, 20, 20);
            ctx.fillStyle = '#0f172a';
            ctx.fillText('Principal', width - 175, 45);
            
            ctx.fillStyle = '#6366f1';
            ctx.fillRect(width - 200, 60, 20, 20);
            ctx.fillStyle = '#0f172a';
            ctx.fillText('Interest', width - 175, 75);
        }
        
        function displaySchedule(schedule) {
            const tbody = document.getElementById('scheduleBody');
            tbody.innerHTML = '';
            
            // Show first year, last year, and a sample in between
            const showCount = 12; // First 12 months
            const lastYear = Math.ceil(schedule.length / 12);
            
            for (let i = 0; i < schedule.length; i++) {
                if (i < showCount || i >= schedule.length - 12) {
                    const row = tbody.insertRow();
                    row.insertCell(0).textContent = 'Month ' + schedule[i].month + ' (Year ' + Math.ceil(schedule[i].month / 12) + ')';
                    row.insertCell(1).textContent = formatCurrency(schedule[i].payment);
                    row.insertCell(2).textContent = formatCurrency(schedule[i].principal);
                    row.insertCell(3).textContent = formatCurrency(schedule[i].interest);
                    row.insertCell(4).textContent = schedule[i].pmi > 0 ? formatCurrency(schedule[i].pmi) : (schedule[i].pmiRemoved ? 'âœ“ Removed' : '-');
                    row.insertCell(5).textContent = formatCurrency(schedule[i].balance);
                }
                
                if (i === showCount - 1 && schedule.length > showCount + 12) {
                    const spacerRow = tbody.insertRow();
                    const cell = spacerRow.insertCell(0);
                    cell.colSpan = 6;
                    cell.textContent = '... (months ' + (showCount + 1) + ' through ' + (schedule.length - 12) + ') ...';
                    cell.style.textAlign = 'center';
                    cell.style.fontStyle = 'italic';
                    cell.style.color = '#64748b';
                }
            }
            
            // Add summary totals
            const totalPayments = schedule.reduce((sum, p) => sum + p.payment, 0);
            const totalPrincipal = schedule.reduce((sum, p) => sum + p.principal, 0);
            const totalInterest = schedule.reduce((sum, p) => sum + p.interest, 0);
            const totalPMI = schedule.reduce((sum, p) => sum + p.pmi, 0);
            
            // Add a separator row
            const separatorRow = tbody.insertRow();
            separatorRow.style.background = '#e2e8f0';
            separatorRow.style.height = '3px';
            const sepCell = separatorRow.insertCell(0);
            sepCell.colSpan = 6;
            
            // Add totals row
            const totalsRow = tbody.insertRow();
            totalsRow.style.background = '#f8fafc';
            totalsRow.style.fontWeight = '700';
            totalsRow.style.fontSize = '1.05em';
            
            const labelCell = totalsRow.insertCell(0);
            labelCell.textContent = 'TOTALS:';
            labelCell.style.textAlign = 'left';
            
            totalsRow.insertCell(1).textContent = formatCurrency(totalPayments);
            totalsRow.insertCell(2).textContent = formatCurrency(totalPrincipal);
            totalsRow.insertCell(3).textContent = formatCurrency(totalInterest);
            totalsRow.insertCell(4).textContent = totalPMI > 0 ? formatCurrency(totalPMI) : '-';
            totalsRow.insertCell(5).textContent = formatCurrency(0);
            
            // Add summary section below table
            const tableWrapper = document.querySelector('.table-wrapper');
            
            // Remove existing summary if it exists
            const existingSummary = document.getElementById('scheduleSummary');
            if (existingSummary) {
                existingSummary.remove();
            }
            
            const summaryDiv = document.createElement('div');
            summaryDiv.id = 'scheduleSummary';
            summaryDiv.style.marginTop = '24px';
            summaryDiv.style.padding = '32px';
            summaryDiv.style.background = 'white';
            summaryDiv.style.borderRadius = '12px';
            summaryDiv.style.border = '1px solid #e2e8f0';
            
            const homePrice = parseFloat(document.getElementById('homePrice').value);
            const downPayment = parseFloat(document.getElementById('downPayment').value);
            const totalCost = homePrice + totalInterest + totalPMI;
            
            summaryDiv.innerHTML = `
                <h3 style="font-size: 1.25rem; margin-bottom: 24px; font-weight: 600; color: #0f172a;">Complete Loan Summary</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px;">
                    <div style="background: #f8fafc; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0;">
                        <div style="font-size: 0.8125rem; color: #64748b; margin-bottom: 8px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">Total Payments</div>
                        <div style="font-size: 2rem; font-weight: 700; color: #0f172a; letter-spacing: -1px;">${schedule.length}</div>
                        <div style="font-size: 0.8125rem; color: #64748b; margin-top: 8px;">${(schedule.length / 12).toFixed(1)} years</div>
                    </div>
                    <div style="background: #f8fafc; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0;">
                        <div style="font-size: 0.8125rem; color: #64748b; margin-bottom: 8px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">Principal Paid</div>
                        <div style="font-size: 2rem; font-weight: 700; color: #0f172a; letter-spacing: -1px;">${formatCurrency(totalPrincipal)}</div>
                        <div style="font-size: 0.8125rem; color: #64748b; margin-top: 8px;">Your loan amount</div>
                    </div>
                    <div style="background: #f8fafc; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0;">
                        <div style="font-size: 0.8125rem; color: #64748b; margin-bottom: 8px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">Interest Paid</div>
                        <div style="font-size: 2rem; font-weight: 700; color: #0f172a; letter-spacing: -1px;">${formatCurrency(totalInterest)}</div>
                        <div style="font-size: 0.8125rem; color: #64748b; margin-top: 8px;">${((totalInterest / totalPrincipal) * 100).toFixed(0)}% of loan</div>
                    </div>
                    ${totalPMI > 0 ? `
                    <div style="background: #f8fafc; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0;">
                        <div style="font-size: 0.8125rem; color: #64748b; margin-bottom: 8px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">PMI/MIP Paid</div>
                        <div style="font-size: 2rem; font-weight: 700; color: #0f172a; letter-spacing: -1px;">${formatCurrency(totalPMI)}</div>
                        <div style="font-size: 0.8125rem; color: #64748b; margin-top: 8px;">${schedule.filter(p => p.pmi > 0).length} months</div>
                    </div>
                    ` : ''}
                    <div style="background: #f8fafc; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0;">
                        <div style="font-size: 0.8125rem; color: #64748b; margin-bottom: 8px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">Total Paid</div>
                        <div style="font-size: 2rem; font-weight: 700; color: #0f172a; letter-spacing: -1px;">${formatCurrency(totalPayments + totalPMI)}</div>
                        <div style="font-size: 0.8125rem; color: #64748b; margin-top: 8px;">Principal + Interest + PMI</div>
                    </div>
                    <div style="background: #f8fafc; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0;">
                        <div style="font-size: 0.8125rem; color: #64748b; margin-bottom: 8px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">True Cost</div>
                        <div style="font-size: 2rem; font-weight: 700; color: #0f172a; letter-spacing: -1px;">${formatCurrency(totalCost)}</div>
                        <div style="font-size: 0.8125rem; color: #64748b; margin-top: 8px;">Purchase + interest + PMI</div>
                    </div>
                </div>
                <div style="margin-top: 24px; padding: 16px 20px; background: #fafbfc; border-radius: 8px; border: 1px solid #e2e8f0; font-size: 0.875rem; color: #475569;">
                    <strong style="color: #0f172a;">Down Payment:</strong> ${formatCurrency(downPayment)} &nbsp;|&nbsp; 
                    <strong style="color: #0f172a;">Home Price:</strong> ${formatCurrency(homePrice)} &nbsp;|&nbsp; 
                    <strong style="color: #0f172a;">Interest Rate:</strong> ${document.getElementById('interestRate').value}%
                </div>
            `;
            
            tableWrapper.appendChild(summaryDiv);
        }
        
        function saveCalculation() {
            const data = {
                loanType: document.getElementById('loanType').value,
                closingDate: document.getElementById('closingDate').value,
                homePrice: document.getElementById('homePrice').value,
                downPayment: document.getElementById('downPayment').value,
                interestRate: document.getElementById('interestRate').value,
                loanTerm: document.getElementById('loanTerm').value,
                propertyTax: document.getElementById('propertyTax').value,
                homeInsurance: document.getElementById('homeInsurance').value,
                hoaFees: document.getElementById('hoaFees').value,
                pmiRate: document.getElementById('pmiRate').value,
                extraMonthly: document.getElementById('extraMonthly').value,
                extraYearly: document.getElementById('extraYearly').value,
                householdIncome: document.getElementById('householdIncome').value,
                savedDate: new Date().toLocaleDateString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'mortgage-calculation-' + new Date().toISOString().split('T')[0] + '.json';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
        
        function loadCalculation(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    document.getElementById('loanType').value = data.loanType || 'conventional';
                    document.getElementById('closingDate').value = data.closingDate || new Date().toISOString().split('T')[0];
                    document.getElementById('homePrice').value = data.homePrice || 300000;
                    document.getElementById('downPayment').value = data.downPayment || 60000;
                    document.getElementById('interestRate').value = data.interestRate || 6.5;
                    document.getElementById('loanTerm').value = data.loanTerm || 30;
                    document.getElementById('propertyTax').value = data.propertyTax || 3000;
                    document.getElementById('homeInsurance').value = data.homeInsurance || 1200;
                    document.getElementById('hoaFees').value = data.hoaFees || 0;
                    document.getElementById('pmiRate').value = data.pmiRate || 0.5;
                    document.getElementById('extraMonthly').value = data.extraMonthly || 0;
                    document.getElementById('extraYearly').value = data.extraYearly || 0;
                    document.getElementById('householdIncome').value = data.householdIncome || 0;
                    
                    updateDownPaymentPercent();
                    updateLoanTypeInfo();
                    calculate();
                } catch (error) {
                    alert('Sorry, there was a problem loading that file.');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }
        
        function displayFiveYearTip(principal, monthlyRate, numPayments, basePI, standardInterest, currentExtra, currentYearly) {
            const targetPayments = numPayments - 60; // 5 years early
            
            if (targetPayments <= 12) {
                document.getElementById('fiveYearSection').innerHTML = '';
                return;
            }
            
            // Binary search for extra payment needed
            let low = 0;
            let high = basePI * 2;
            let additionalExtra = 0;
            
            for (let i = 0; i < 100; i++) {
                const testExtra = (low + high) / 2;
                const totalExtra = currentExtra + testExtra;
                let balance = principal;
                let months = 0;
                
                while (balance > 0 && months < numPayments) {
                    months++;
                    const interest = balance * monthlyRate;
                    let principalPmt = basePI + totalExtra - interest;
                    if (months % 12 === 0) principalPmt += currentYearly;
                    if (principalPmt > balance) principalPmt = balance;
                    balance -= principalPmt;
                    if (balance <= 0) break;
                }
                
                if (months > targetPayments) {
                    low = testExtra;
                } else {
                    high = testExtra;
                }
                additionalExtra = testExtra;
                if (Math.abs(months - targetPayments) <= 1) break;
            }
            
            // Calculate interest with this additional extra
            let balance = principal;
            let totalInterest = 0;
            let months = 0;
            const totalExtra = currentExtra + additionalExtra;
            
            while (balance > 0 && months < numPayments) {
                months++;
                const interest = balance * monthlyRate;
                let principalPmt = basePI + totalExtra - interest;
                if (months % 12 === 0) principalPmt += currentYearly;
                if (principalPmt > balance) principalPmt = balance;
                balance -= principalPmt;
                totalInterest += interest;
                if (balance <= 0) break;
            }
            
            const interestSaved = standardInterest - totalInterest;
            
            if (additionalExtra < 10 || additionalExtra > basePI * 0.8) {
                document.getElementById('fiveYearSection').innerHTML = '';
                return;
            }
            
            let html = '<div class="section">';
            html += '<div class="section-title">Quick Tip: Pay Off 5 Years Early</div>';
            html += '<div class="info-box">';
            html += '<strong>Want to own your home 5 years sooner?</strong><br><br>';
            
            if (currentExtra > 0) {
                html += 'You\'re already paying an extra ' + formatCurrency(currentExtra) + ' monthly. ';
                html += 'By adding just <strong>' + formatCurrency(additionalExtra) + ' more</strong> (total: ' + formatCurrency(totalExtra) + '), you could:<br><br>';
            } else {
                html += 'By adding just <strong>' + formatCurrency(additionalExtra) + '</strong> to your monthly payment, you could:<br><br>';
            }
            
            html += 'â€¢ Pay off your mortgage 5 years early<br>';
            html += 'â€¢ Save <strong>' + formatCurrency(interestSaved) + '</strong> in interest<br>';
            html += 'â€¢ Build equity faster<br><br>';
            html += '<em>Your new monthly payment would be: ' + formatCurrency(basePI + totalExtra) + '</em>';
            html += '</div>';
            html += '</div>';
            
            document.getElementById('fiveYearSection').innerHTML = html;
        }
        
        function compare15vs30(homePrice, downPayment, interestRate, propertyTax, homeInsurance, hoaFees, pmiRate, loanType) {
            const loanAmount = homePrice - downPayment;
            const downPaymentPercent = (downPayment / homePrice) * 100;
            
            const terms = [15, 30];
            const results = terms.map(term => {
                const monthlyRate = interestRate / 12;
                const numPayments = term * 12;
                const monthlyPI = loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / (Math.pow(1 + monthlyRate, numPayments) - 1);
                
                let monthlyPMI = 0;
                if (loanType === 'fha') {
                    monthlyPMI = (loanAmount * pmiRate) / 12;
                } else if (downPaymentPercent < 20) {
                    monthlyPMI = (loanAmount * pmiRate) / 12;
                }
                
                const totalPayment = monthlyPI + (propertyTax / 12) + (homeInsurance / 12) + hoaFees + monthlyPMI;
                const totalPaid = monthlyPI * numPayments;
                const totalInterest = totalPaid - loanAmount;
                
                return {
                    term: term,
                    monthlyPayment: totalPayment,
                    totalInterest: totalInterest
                };
            });
            
            const interestDiff = results[1].totalInterest - results[0].totalInterest;
            const paymentDiff = results[0].monthlyPayment - results[1].monthlyPayment;
            const percentSavings = ((interestDiff / results[1].totalInterest) * 100).toFixed(0);
            
            let html = '<div class="section">';
            html += '<div class="section-title">15-Year vs 30-Year Comparison</div>';
            html += '<div class="comparison-grid">';
            
            results.forEach((result, index) => {
                const is15Year = index === 0;
                html += '<div class="comparison-card' + (is15Year ? ' success' : '') + '">';
                html += '<div class="comparison-title">' + result.term + '-Year Loan</div>';
                
                if (is15Year) {
                    html += '<div style="background: #22c55e; color: white; padding: 12px; border-radius: 8px; margin-bottom: 16px; text-align: center; font-weight: 600; font-size: 0.9375rem;">';
                    html += 'Save ' + formatCurrency(interestDiff) + ' in Interest';
                    html += '</div>';
                }
                
                html += '<div class="comparison-item">';
                html += '<span class="comparison-label">Monthly Payment:</span>';
                html += '<span class="comparison-value">' + formatCurrency(result.monthlyPayment) + '</span>';
                html += '</div>';
                html += '<div class="comparison-item">';
                html += '<span class="comparison-label">Total Interest:</span>';
                html += '<span class="comparison-value">' + formatCurrency(result.totalInterest) + '</span>';
                html += '</div>';
                html += '</div>';
            });
            
            html += '</div>';
            
            html += '<div class="info-box" style="margin-top: 20px;">';
            html += '<strong>The Big Picture:</strong><br><br>';
            html += 'â€¢ <strong>15-Year:</strong> Pay ' + formatCurrency(paymentDiff) + ' MORE per month, save ' + percentSavings + '% in interest<br>';
            html += 'â€¢ <strong>30-Year:</strong> Lower payment, more flexibility, but costs more long-term<br><br>';
            html += '<strong>Pro tip:</strong> Get a 30-year loan and make extra payments for the best of both worlds!';
            html += '</div>';
            html += '</div>';
            
            document.getElementById('loanComparisonSection').innerHTML = html;
        }
        
        function calculateClosingCosts(loanAmount, homePrice, propertyTax, homeInsurance, downPayment, loanType) {
            const originationFee = loanAmount * 0.01;
            const titleInsurance = homePrice * 0.005;
            const prepaidTax = propertyTax / 2;
            const prepaidInsurance = homeInsurance;
            const fhaUpfrontMIP = loanType === 'fha' ? loanAmount * 0.0175 : 0;
            
            const totalClosingCosts = originationFee + 500 + 50 + titleInsurance + 800 + 450 + 200 + prepaidTax + prepaidInsurance + fhaUpfrontMIP;
            const cashNeeded = downPayment + totalClosingCosts;
            
            let html = '<div class="section-title">Estimated Closing Costs</div>';
            html += '<div class="cost-row">';
            html += '<span class="cost-label">Loan Origination Fee (1%)</span>';
            html += '<span class="cost-value">' + formatCurrency(originationFee) + '</span>';
            html += '</div>';
            html += '<div class="cost-row">';
            html += '<span class="cost-label">Appraisal Fee</span>';
            html += '<span class="cost-value">$500</span>';
            html += '</div>';
            html += '<div class="cost-row">';
            html += '<span class="cost-label">Credit Report</span>';
            html += '<span class="cost-value">$50</span>';
            html += '</div>';
            html += '<div class="cost-row">';
            html += '<span class="cost-label">Title Search & Insurance</span>';
            html += '<span class="cost-value">' + formatCurrency(titleInsurance) + '</span>';
            html += '</div>';
            html += '<div class="cost-row">';
            html += '<span class="cost-label">Attorney Fees</span>';
            html += '<span class="cost-value">$800</span>';
            html += '</div>';
            html += '<div class="cost-row">';
            html += '<span class="cost-label">Home Inspection</span>';
            html += '<span class="cost-value">$450</span>';
            html += '</div>';
            html += '<div class="cost-row">';
            html += '<span class="cost-label">Recording Fees</span>';
            html += '<span class="cost-value">$200</span>';
            html += '</div>';
            
            if (loanType === 'fha') {
                html += '<div class="cost-row">';
                html += '<span class="cost-label">FHA Upfront Mortgage Insurance (1.75%)</span>';
                html += '<span class="cost-value">' + formatCurrency(fhaUpfrontMIP) + '</span>';
                html += '</div>';
            }
            
            html += '<div class="cost-row">';
            html += '<span class="cost-label">Prepaid Property Tax (6 months)</span>';
            html += '<span class="cost-value">' + formatCurrency(prepaidTax) + '</span>';
            html += '</div>';
            html += '<div class="cost-row">';
            html += '<span class="cost-label">Prepaid Insurance (1 year)</span>';
            html += '<span class="cost-value">' + formatCurrency(prepaidInsurance) + '</span>';
            html += '</div>';
            html += '<div class="cost-row cost-total">';
            html += '<span class="cost-label">Total Closing Costs:</span>';
            html += '<span class="cost-value">' + formatCurrency(totalClosingCosts) + '</span>';
            html += '</div>';
            html += '<div class="cost-row cost-total">';
            html += '<span class="cost-label">Cash Needed at Closing:</span>';
            html += '<span class="cost-value">' + formatCurrency(cashNeeded) + '</span>';
            html += '</div>';
            
            document.getElementById('closingCostsSection').innerHTML = html;
        }
        
        updateDownPaymentPercent();
        updateLoanTypeInfo();
    </script>
</body>
</html>
