<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maine Mortgage Calculator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            padding: 20px;
            color: #2d3748;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        h1 {
            color: #1a365d;
            margin-bottom: 10px;
            font-size: 2.2em;
            font-weight: 700;
        }
        
        .subtitle {
            color: #718096;
            font-size: 1.1em;
        }
        
        .section {
            background: #f8fafc;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 25px;
            border: 1px solid #e2e8f0;
        }
        
        .section-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #4299e1;
        }
        
        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 8px;
            font-size: 0.95em;
        }
        
        .help-text {
            font-size: 0.85em;
            color: #718096;
            margin-top: 4px;
        }
        
        input[type="number"], input[type="date"], select {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.2s;
            background: white;
        }
        
        input[type="number"]:focus, input[type="date"]:focus, select:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }
        
        .button-bar {
            display: flex;
            gap: 15px;
            margin: 30px 0;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        button {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-calculate {
            background: #4299e1;
            color: white;
            font-size: 1.1em;
            padding: 16px 40px;
        }
        
        .btn-calculate:hover {
            background: #3182ce;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(66, 153, 225, 0.4);
        }
        
        .btn-save {
            background: #48bb78;
            color: white;
        }
        
        .btn-save:hover {
            background: #38a169;
            transform: translateY(-1px);
        }
        
        .btn-load {
            background: #ed8936;
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .btn-load:hover {
            background: #dd6b20;
            transform: translateY(-1px);
        }
        
        .btn-load input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        
        .results-highlight {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 35px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 25px;
        }
        
        .result-card {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }
        
        .result-label {
            font-size: 0.9em;
            opacity: 0.95;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .result-value {
            font-size: 2em;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        .result-subtext {
            font-size: 0.85em;
            margin-top: 8px;
            opacity: 0.9;
        }
        
        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .comparison-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-top: 4px solid #4299e1;
        }
        
        .comparison-card.success {
            border-top-color: #48bb78;
            background: #f0fff4;
        }
        
        .comparison-card.warning {
            border-top-color: #ed8936;
            background: #fffaf0;
        }
        
        .comparison-title {
            font-size: 1.4em;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 15px;
        }
        
        .comparison-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .comparison-item:last-child {
            border-bottom: none;
        }
        
        .comparison-label {
            color: #4a5568;
            font-size: 0.95em;
        }
        
        .comparison-value {
            font-weight: 600;
            color: #2d3748;
        }
        
        .savings-highlight {
            background: #48bb78;
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin-top: 15px;
            font-weight: 600;
        }
        
        .warning-box {
            background: #fff5f5;
            border-left: 4px solid #f56565;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .info-box {
            background: #ebf8ff;
            border-left: 4px solid #4299e1;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .success-box {
            background: #f0fff4;
            border-left: 4px solid #48bb78;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .chart-section {
            background: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 25px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .chart-header {
            font-size: 1.2em;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 20px;
        }
        
        canvas {
            max-width: 100%;
        }
        
        .costs-breakdown {
            background: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 25px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .cost-row {
            display: flex;
            justify-content: space-between;
            padding: 14px 0;
            border-bottom: 1px solid #e2e8f0;
            align-items: center;
        }
        
        .cost-row:last-child {
            border-bottom: none;
        }
        
        .cost-label {
            color: #4a5568;
            font-size: 0.95em;
        }
        
        .cost-value {
            font-weight: 600;
            color: #2d3748;
            font-size: 1em;
        }
        
        .cost-total {
            background: #edf2f7;
            padding: 18px;
            border-radius: 8px;
            margin-top: 15px;
            font-weight: 700;
            font-size: 1.1em;
        }
        
        .table-wrapper {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: #4299e1;
            color: white;
            padding: 14px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.95em;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.95em;
        }
        
        tr:hover {
            background: #f7fafc;
        }
        
        tr.pmi-removal {
            background: #f0fff4;
            font-weight: 600;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 1.6em;
            }
            
            .result-value {
                font-size: 1.5em;
            }
            
            .button-bar {
                flex-direction: column;
            }
            
            button {
                width: 100%;
                justify-content: center;
            }
            
            .comparison-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè° Maine Mortgage Calculator</h1>
            <p class="subtitle">Plan your home purchase with confidence</p>
        </div>
        
        <div class="section">
            <div class="section-title">Basic Information</div>
            <div class="input-grid">
                <div class="input-group">
                    <label for="loanType">Loan Type</label>
                    <select id="loanType" onchange="updateLoanTypeInfo()">
                        <option value="conventional">Conventional Loan</option>
                        <option value="fha">FHA Loan</option>
                    </select>
                    <span class="help-text" id="loanTypeHelp">PMI removable at 20% equity</span>
                </div>
                <div class="input-group">
                    <label for="closingDate">Closing Date</label>
                    <input type="date" id="closingDate">
                    <span class="help-text">First payment ~30 days after</span>
                </div>
                <div class="input-group">
                    <label for="homePrice">Home Price</label>
                    <input type="number" id="homePrice" value="300000" step="1000">
                </div>
                <div class="input-group">
                    <label for="downPayment">Down Payment</label>
                    <input type="number" id="downPayment" value="60000" step="1000">
                    <span class="help-text" id="downPaymentPercent">20% down</span>
                </div>
                <div class="input-group">
                    <label for="interestRate">Interest Rate (%)</label>
                    <input type="number" id="interestRate" value="6.5" step="0.01">
                </div>
                <div class="input-group">
                    <label for="loanTerm">Loan Length</label>
                    <select id="loanTerm">
                        <option value="15">15 years</option>
                        <option value="20">20 years</option>
                        <option value="30" selected>30 years</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="section">
            <div class="section-title">Monthly Costs</div>
            <div class="input-grid">
                <div class="input-group">
                    <label for="propertyTax">Yearly Property Tax</label>
                    <input type="number" id="propertyTax" value="3000" step="100">
                </div>
                <div class="input-group">
                    <label for="homeInsurance">Yearly Home Insurance</label>
                    <input type="number" id="homeInsurance" value="1200" step="100">
                </div>
                <div class="input-group">
                    <label for="hoaFees">Monthly HOA Fees</label>
                    <input type="number" id="hoaFees" value="0" step="10">
                </div>
                <div class="input-group">
                    <label for="pmiRate">Mortgage Insurance Rate (%)</label>
                    <input type="number" id="pmiRate" value="0.5" step="0.1">
                    <span class="help-text" id="pmiHelp">Required if less than 20% down</span>
                </div>
            </div>
        </div>
        
        <div class="section">
            <div class="section-title">Extra Payments (Optional)</div>
            <div class="input-grid">
                <div class="input-group">
                    <label for="extraMonthly">Extra Monthly Payment</label>
                    <input type="number" id="extraMonthly" value="0" step="50">
                    <span class="help-text">Your commitment each month</span>
                </div>
                <div class="input-group">
                    <label for="extraYearly">Extra Yearly Payment</label>
                    <input type="number" id="extraYearly" value="0" step="100">
                    <span class="help-text">E.g., tax refund or bonus</span>
                </div>
                <div class="input-group">
                    <label for="householdIncome">Household Income (Optional)</label>
                    <input type="number" id="householdIncome" value="0" step="1000">
                    <span class="help-text">For affordability check</span>
                </div>
            </div>
        </div>
        
        <div class="button-bar">
            <button class="btn-calculate" onclick="calculate()">
                <span>üìä</span> Calculate Payment
            </button>
            <button class="btn-save" onclick="saveCalculation()">
                <span>üíæ</span> Save Calculation
            </button>
            <button class="btn-load">
                <span>üìÇ</span> Load Saved Calculation
                <input type="file" id="fileInput" accept=".json" onchange="loadCalculation(event)">
            </button>
        </div>
        
        <div id="results" style="display: none;">
            <div class="results-highlight" id="mainResults"></div>
            
            <div id="accountabilitySection"></div>
            <div id="affordabilitySection"></div>
            <div id="pmiInfoSection"></div>
            <div id="pmiRedirectSection"></div>
            <div id="fiveYearSection"></div>
            <div id="loanComparisonSection"></div>
            
            <div class="costs-breakdown" id="closingCostsSection"></div>
            
            <div class="chart-section">
                <div class="chart-header">Monthly Payment Breakdown</div>
                <canvas id="paymentChart"></canvas>
            </div>
            
            <div class="chart-section">
                <div class="chart-header">Principal vs Interest Over Time</div>
                <canvas id="principalInterestChart"></canvas>
            </div>
            
            <div class="table-wrapper">
                <div class="chart-header">Complete Payment Schedule</div>
                <table id="amortizationTable">
                    <thead>
                        <tr>
                            <th>Month</th>
                            <th>Payment</th>
                            <th>Principal</th>
                            <th>Interest</th>
                            <th>PMI/MIP</th>
                            <th>Balance</th>
                        </tr>
                    </thead>
                    <tbody id="amortizationBody"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
        let paymentChart = null;
        let principalInterestChart = null;
        
        // Set default closing date to today
        document.getElementById('closingDate').valueAsDate = new Date();
        
        function formatCurrency(amount) {
            return '$' + Math.round(amount).toLocaleString('en-US');
        }
        
        function formatDate(date) {
            return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
        }
        
        function calculateFirstPaymentDate(closingDate) {
            const closing = new Date(closingDate);
            // Add 30 days
            closing.setDate(closing.getDate() + 30);
            // Round to 1st of next month
            if (closing.getDate() > 1) {
                closing.setMonth(closing.getMonth() + 1);
                closing.setDate(1);
            }
            return closing;
        }
        
        function updateDownPaymentPercent() {
            const homePrice = parseFloat(document.getElementById('homePrice').value) || 0;
            const downPayment = parseFloat(document.getElementById('downPayment').value) || 0;
            if (homePrice > 0) {
                const percent = ((downPayment / homePrice) * 100).toFixed(1);
                document.getElementById('downPaymentPercent').textContent = percent + '% down';
            }
        }
        
        function updateLoanTypeInfo() {
            const loanType = document.getElementById('loanType').value;
            const homePrice = parseFloat(document.getElementById('homePrice').value) || 0;
            const downPayment = parseFloat(document.getElementById('downPayment').value) || 0;
            const downPaymentPercent = (downPayment / homePrice) * 100;
            
            if (loanType === 'fha') {
                document.getElementById('loanTypeHelp').textContent = 'MIP for life of loan (if <10% down)';
                document.getElementById('pmiRate').value = '0.55';
                
                if (downPaymentPercent >= 10) {
                    document.getElementById('pmiHelp').textContent = 'MIP for 11 years (10%+ down)';
                } else {
                    document.getElementById('pmiHelp').textContent = 'MIP for life of loan (<10% down)';
                }
            } else {
                document.getElementById('loanTypeHelp').textContent = 'PMI removable at 20% equity';
                document.getElementById('pmiRate').value = '0.5';
                document.getElementById('pmiHelp').textContent = 'Removed at 20% equity';
            }
        }
        
        document.getElementById('homePrice').addEventListener('input', function() {
            updateDownPaymentPercent();
            updateLoanTypeInfo();
        });
        document.getElementById('downPayment').addEventListener('input', function() {
            updateDownPaymentPercent();
            updateLoanTypeInfo();
        });
        
        function calculate() {
            const loanType = document.getElementById('loanType').value;
            const closingDate = document.getElementById('closingDate').value;
            const homePrice = parseFloat(document.getElementById('homePrice').value);
            const downPayment = parseFloat(document.getElementById('downPayment').value);
            const interestRate = parseFloat(document.getElementById('interestRate').value) / 100;
            const loanTerm = parseInt(document.getElementById('loanTerm').value);
            const propertyTax = parseFloat(document.getElementById('propertyTax').value);
            const homeInsurance = parseFloat(document.getElementById('homeInsurance').value);
            const hoaFees = parseFloat(document.getElementById('hoaFees').value);
            const pmiRate = parseFloat(document.getElementById('pmiRate').value) / 100;
            const extraMonthly = parseFloat(document.getElementById('extraMonthly').value) || 0;
            const extraYearly = parseFloat(document.getElementById('extraYearly').value) || 0;
            const householdIncome = parseFloat(document.getElementById('householdIncome').value) || 0;
            
            const loanAmount = homePrice - downPayment;
            const monthlyRate = interestRate / 12;
            const numPayments = loanTerm * 12;
            const downPaymentPercent = (downPayment / homePrice) * 100;
            
            // Calculate base monthly P&I payment
            const monthlyPI = loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / (Math.pow(1 + monthlyRate, numPayments) - 1);
            const monthlyTax = propertyTax / 12;
            const monthlyIns = homeInsurance / 12;
            
            // Calculate PMI/MIP details
            let pmiRemovalMonth = 0;
            let monthlyPMI = 0;
            
            if (loanType === 'fha') {
                monthlyPMI = (loanAmount * pmiRate) / 12;
                if (downPaymentPercent >= 10) {
                    pmiRemovalMonth = 11 * 12;
                } else {
                    pmiRemovalMonth = numPayments;
                }
            } else {
                if (downPaymentPercent < 20) {
                    monthlyPMI = (loanAmount * pmiRate) / 12;
                    const targetBalance = homePrice * 0.8;
                    let balance = loanAmount;
                    for (let i = 1; i <= numPayments; i++) {
                        const interest = balance * monthlyRate;
                        const principal = monthlyPI - interest + (extraMonthly || 0);
                        balance -= principal;
                        if (balance <= targetBalance) {
                            pmiRemovalMonth = i;
                            break;
                        }
                    }
                }
            }
            
            // Calculate WITHOUT extra payments (required payment only)
            const requiredPayment = monthlyPI + monthlyTax + monthlyIns + hoaFees + monthlyPMI;
            const standardSchedule = generateAmortizationSchedule(
                loanAmount, monthlyRate, numPayments, monthlyPI, 0, 0, 
                pmiRemovalMonth, monthlyPMI, loanType, downPaymentPercent
            );
            const standardTotalInterest = standardSchedule.reduce((sum, pmt) => sum + pmt.interest, 0);
            const standardPayoffMonths = standardSchedule.length;
            
            // Calculate WITH extra payments (actual commitment)
            let actualSchedule, actualPayment, actualTotalInterest, actualPayoffMonths;
            if (extraMonthly > 0 || extraYearly > 0) {
                actualSchedule = generateAmortizationSchedule(
                    loanAmount, monthlyRate, numPayments, monthlyPI, extraMonthly, extraYearly,
                    pmiRemovalMonth, monthlyPMI, loanType, downPaymentPercent
                );
                actualTotalInterest = actualSchedule.reduce((sum, pmt) => sum + pmt.interest, 0);
                actualPayoffMonths = actualSchedule.length;
                actualPayment = requiredPayment + extraMonthly;
            } else {
                actualSchedule = standardSchedule;
                actualPayment = requiredPayment;
                actualTotalInterest = standardTotalInterest;
                actualPayoffMonths = standardPayoffMonths;
            }
            
            // Calculate first payment date
            const firstPaymentDate = calculateFirstPaymentDate(closingDate);
            const standardPayoffDate = new Date(firstPaymentDate);
            standardPayoffDate.setMonth(standardPayoffDate.getMonth() + standardPayoffMonths);
            const actualPayoffDate = new Date(firstPaymentDate);
            actualPayoffDate.setMonth(actualPayoffDate.getMonth() + actualPayoffMonths);
            
            // Display main results
            displayMainResults(requiredPayment, actualPayment, loanAmount, standardTotalInterest, 
                actualTotalInterest, standardPayoffDate, actualPayoffDate, extraMonthly, extraYearly);
            
            // Display accountability section
            if (extraMonthly > 0 || extraYearly > 0) {
                displayAccountabilitySection(standardSchedule, actualSchedule, standardTotalInterest, 
                    actualTotalInterest, standardPayoffDate, actualPayoffDate, extraMonthly, extraYearly);
            } else {
                document.getElementById('accountabilitySection').innerHTML = '';
            }
            
            // Other sections
            if (householdIncome > 0) {
                displayAffordabilityCheck(actualPayment, householdIncome);
            } else {
                document.getElementById('affordabilitySection').innerHTML = '';
            }
            
            displayPMIInfo(loanType, downPaymentPercent, monthlyPMI, pmiRemovalMonth, loanTerm, actualSchedule);
            displayPMIRedirectStrategy(loanAmount, monthlyRate, numPayments, monthlyPI, pmiRemovalMonth, monthlyPMI, extraMonthly, extraYearly, actualSchedule);
            displayFiveYearTip(loanAmount, monthlyRate, numPayments, monthlyPI, standardTotalInterest, extraMonthly, extraYearly);
            compare15vs30(homePrice, downPayment, interestRate, propertyTax, homeInsurance, hoaFees, pmiRate, loanType);
            calculateClosingCosts(loanAmount, homePrice, propertyTax, homeInsurance, downPayment, loanType);
            
            createPaymentChart(monthlyPI, monthlyTax, monthlyIns, hoaFees, monthlyPMI, extraMonthly);
            createPrincipalInterestChart(actualSchedule);
            displayAmortizationTable(actualSchedule);
            
            document.getElementById('results').style.display = 'block';
            document.getElementById('results').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        function generateAmortizationSchedule(principal, monthlyRate, maxPayments, basePI, extraMonthly, extraYearly, 
            pmiRemovalMonth, monthlyPMI, loanType, downPaymentPercent) {
            const schedule = [];
            let balance = principal;
            let currentPMI = monthlyPMI;
            
            for (let month = 1; month <= maxPayments && balance > 0.01; month++) {
                const interest = balance * monthlyRate;
                let principalPayment = basePI - interest + extraMonthly;
                
                // Add yearly extra
                if (month % 12 === 0) {
                    principalPayment += extraYearly;
                }
                
                // Don't overpay
                if (principalPayment > balance) {
                    principalPayment = balance;
                }
                
                balance -= principalPayment;
                
                // Check if PMI should be removed this month
                if (month === pmiRemovalMonth) {
                    currentPMI = 0;
                }
                
                schedule.push({
                    month: month,
                    payment: basePI + extraMonthly + (month % 12 === 0 ? extraYearly : 0),
                    principal: principalPayment,
                    interest: interest,
                    pmi: currentPMI,
                    balance: Math.max(0, balance),
                    pmiRemoved: (month === pmiRemovalMonth && currentPMI === 0)
                });
                
                if (balance <= 0) break;
            }
            
            return schedule;
        }
        
        function displayMainResults(required, actual, loanAmount, standardInterest, actualInterest, 
            standardDate, actualDate, extraMonthly, extraYearly) {
            const hasExtras = extraMonthly > 0 || extraYearly > 0;
            
            let html = '<div class="results-grid">';
            
            // Required payment
            html += '<div class="result-card">';
            html += '<div class="result-label">Required Monthly Payment</div>';
            html += '<div class="result-value">' + formatCurrency(required) + '</div>';
            if (hasExtras) {
                html += '<div class="result-subtext">Minimum due each month</div>';
            }
            html += '</div>';
            
            // Actual payment (if different)
            if (hasExtras) {
                html += '<div class="result-card">';
                html += '<div class="result-label">Your Committed Payment</div>';
                html += '<div class="result-value">' + formatCurrency(actual) + '</div>';
                html += '<div class="result-subtext">With your extra payments</div>';
                html += '</div>';
            }
            
            // Loan amount
            html += '<div class="result-card">';
            html += '<div class="result-label">Total Loan Amount</div>';
            html += '<div class="result-value">' + formatCurrency(loanAmount) + '</div>';
            html += '</div>';
            
            // Interest
            html += '<div class="result-card">';
            html += '<div class="result-label">Total Interest Paid</div>';
            html += '<div class="result-value">' + formatCurrency(actualInterest) + '</div>';
            if (hasExtras) {
                const saved = standardInterest - actualInterest;
                html += '<div class="result-subtext">Saving ' + formatCurrency(saved) + '</div>';
            }
            html += '</div>';
            
            // Payoff date
            html += '<div class="result-card">';
            html += '<div class="result-label">Loan Payoff Date</div>';
            html += '<div class="result-value" style="font-size: 1.4em;">' + formatDate(actualDate) + '</div>';
            if (hasExtras) {
                const monthsDiff = (standardDate - actualDate) / (1000 * 60 * 60 * 24 * 30);
                const yearsSaved = Math.floor(monthsDiff / 12);
                const monthsSaved = Math.round(monthsDiff % 12);
                if (yearsSaved > 0 || monthsSaved > 0) {
                    html += '<div class="result-subtext">';
                    if (yearsSaved > 0) html += yearsSaved + ' year' + (yearsSaved > 1 ? 's' : '');
                    if (monthsSaved > 0) html += (yearsSaved > 0 ? ' ' : '') + monthsSaved + ' month' + (monthsSaved > 1 ? 's' : '');
                    html += ' early!</div>';
                }
            }
            html += '</div>';
            
            html += '</div>';
            document.getElementById('mainResults').innerHTML = html;
        }
        
        function displayAccountabilitySection(standardSchedule, actualSchedule, standardInterest, 
            actualInterest, standardDate, actualDate, extraMonthly, extraYearly) {
            const interestSaved = standardInterest - actualInterest;
            const monthsSaved = standardSchedule.length - actualSchedule.length;
            const yearsSaved = Math.floor(monthsSaved / 12);
            const monthsRem = monthsSaved % 12;
            
            let html = '<div class="section">';
            html += '<div class="section-title">üí™ Your Commitment & Accountability</div>';
            html += '<div class="comparison-grid">';
            
            // Success scenario (with extras)
            html += '<div class="comparison-card success">';
            html += '<div class="comparison-title">‚úÖ If You Keep Your Commitment</div>';
            html += '<div class="comparison-item">';
            html += '<span class="comparison-label">Extra Monthly:</span>';
            html += '<span class="comparison-value">' + formatCurrency(extraMonthly) + '</span>';
            html += '</div>';
            if (extraYearly > 0) {
                html += '<div class="comparison-item">';
                html += '<span class="comparison-label">Extra Yearly:</span>';
                html += '<span class="comparison-value">' + formatCurrency(extraYearly) + '</span>';
                html += '</div>';
            }
            html += '<div class="comparison-item">';
            html += '<span class="comparison-label">Payoff Date:</span>';
            html += '<span class="comparison-value">' + formatDate(actualDate) + '</span>';
            html += '</div>';
            html += '<div class="comparison-item">';
            html += '<span class="comparison-label">Total Interest:</span>';
            html += '<span class="comparison-value">' + formatCurrency(actualInterest) + '</span>';
            html += '</div>';
            html += '<div class="savings-highlight">';
            html += 'Save ' + formatCurrency(interestSaved) + ' and pay off ';
            if (yearsSaved > 0) html += yearsSaved + ' year' + (yearsSaved > 1 ? 's' : '');
            if (monthsRem > 0) html += (yearsSaved > 0 ? ' ' : '') + monthsRem + ' month' + (monthsRem > 1 ? 's' : '');
            html += ' early!';
            html += '</div>';
            html += '</div>';
            
            // Warning scenario (without extras)
            html += '<div class="comparison-card warning">';
            html += '<div class="comparison-title">‚ö†Ô∏è If You Don\'t Make Extra Payments</div>';
            html += '<div class="comparison-item">';
            html += '<span class="comparison-label">Required Payment Only:</span>';
            html += '<span class="comparison-value">' + formatCurrency(standardSchedule[0].payment - extraMonthly) + '</span>';
            html += '</div>';
            html += '<div class="comparison-item">';
            html += '<span class="comparison-label">Payoff Date:</span>';
            html += '<span class="comparison-value">' + formatDate(standardDate) + '</span>';
            html += '</div>';
            html += '<div class="comparison-item">';
            html += '<span class="comparison-label">Total Interest:</span>';
            html += '<span class="comparison-value">' + formatCurrency(standardInterest) + '</span>';
            html += '</div>';
            html += '<div class="warning-box">';
            html += 'You\'ll pay ' + formatCurrency(interestSaved) + ' MORE in interest and take ';
            if (yearsSaved > 0) html += yearsSaved + ' year' + (yearsSaved > 1 ? 's' : '');
            if (monthsRem > 0) html += (yearsSaved > 0 ? ' ' : '') + monthsRem + ' month' + (monthsRem > 1 ? 's' : '');
            html += ' longer to own your home.';
            html += '</div>';
            html += '</div>';
            
            html += '</div>';
            html += '</div>';
            
            document.getElementById('accountabilitySection').innerHTML = html;
        }
        
        function displayAffordabilityCheck(monthlyPayment, income) {
            const monthlyIncome = income / 12;
            const percentOfIncome = (monthlyPayment / monthlyIncome * 100).toFixed(1);
            const recommendedMax = monthlyIncome * 0.28;
            
            let html = '<div class="section">';
            html += '<div class="section-title">Affordability Check</div>';
            
            if (percentOfIncome <= 28) {
                html += '<div class="success-box">';
                html += '<strong>‚úì Looking Good!</strong><br>';
                html += `Your monthly payment is ${percentOfIncome}% of your income. Lenders typically recommend keeping housing costs below 28% of gross income.`;
                html += '</div>';
            } else if (percentOfIncome <= 35) {
                html += '<div class="info-box">';
                html += '<strong>‚ö† Stretching It</strong><br>';
                html += `Your monthly payment is ${percentOfIncome}% of your income. This is above the recommended 28% threshold but may still be manageable.`;
                html += '</div>';
            } else {
                html += '<div class="warning-box">';
                html += '<strong>‚ö† High Payment</strong><br>';
                html += `Your monthly payment is ${percentOfIncome}% of your income. This exceeds typical lending guidelines and may strain your budget.`;
                html += '</div>';
            }
            
            html += '<div style="margin-top: 15px; padding: 15px; background: white; border-radius: 8px;">';
            html += '<div style="display: flex; justify-content: space-between; margin-bottom: 10px;">';
            html += '<span>Monthly Income:</span><strong>' + formatCurrency(monthlyIncome) + '</strong>';
            html += '</div>';
            html += '<div style="display: flex; justify-content: space-between; margin-bottom: 10px;">';
            html += '<span>Monthly Payment:</span><strong>' + formatCurrency(monthlyPayment) + '</strong>';
            html += '</div>';
            html += '<div style="display: flex; justify-content: space-between; padding-top: 10px; border-top: 2px solid #e2e8f0;">';
            html += '<span>Recommended Max (28%):</span><strong>' + formatCurrency(recommendedMax) + '</strong>';
            html += '</div>';
            html += '</div>';
            html += '</div>';
            
            document.getElementById('affordabilitySection').innerHTML = html;
        }
        
        function displayPMIInfo(loanType, downPaymentPercent, monthlyPMI, pmiRemovalMonth, loanTerm, schedule) {
            if (monthlyPMI === 0) {
                document.getElementById('pmiInfoSection').innerHTML = '';
                return;
            }
            
            const totalPMIPaid = schedule.filter(p => p.pmi > 0).reduce((sum, p) => sum + p.pmi, 0);
            const removalDate = pmiRemovalMonth > 0 && pmiRemovalMonth < schedule.length ? 
                new Date(calculateFirstPaymentDate(document.getElementById('closingDate').value)) : null;
            if (removalDate) {
                removalDate.setMonth(removalDate.getMonth() + pmiRemovalMonth);
            }
            
            let html = '<div class="section">';
            
            if (loanType === 'fha') {
                html += '<div class="section-title">üìã FHA Mortgage Insurance (MIP)</div>';
                html += '<div class="info-box">';
                html += '<strong>About FHA Mortgage Insurance:</strong><br><br>';
                html += '‚Ä¢ <strong>Monthly Premium:</strong> ' + formatCurrency(monthlyPMI) + '<br>';
                
                if (downPaymentPercent >= 10) {
                    html += '‚Ä¢ <strong>Duration:</strong> 11 years (removable ' + formatDate(removalDate) + ')<br>';
                    html += '‚Ä¢ <strong>Total MIP Cost:</strong> ' + formatCurrency(totalPMIPaid) + '<br><br>';
                    html += 'üí° With 10%+ down, your MIP will drop off automatically after 11 years.';
                } else {
                    html += '‚Ä¢ <strong>Duration:</strong> Life of the loan<br>';
                    html += '‚Ä¢ <strong>Total MIP Cost:</strong> ' + formatCurrency(totalPMIPaid) + '<br><br>';
                    html += '‚ö†Ô∏è With less than 10% down, MIP stays for the entire loan. Consider refinancing to conventional when you reach 20% equity.';
                }
                html += '</div>';
            } else {
                html += '<div class="section-title">üìã Private Mortgage Insurance (PMI)</div>';
                html += '<div class="success-box">';
                html += '<strong>Good News About PMI:</strong><br><br>';
                html += '‚Ä¢ <strong>Monthly Cost:</strong> ' + formatCurrency(monthlyPMI) + '<br>';
                html += '‚Ä¢ <strong>Removal Date:</strong> ' + formatDate(removalDate) + '<br>';
                html += '‚Ä¢ <strong>Total PMI Cost:</strong> ' + formatCurrency(totalPMIPaid) + '<br><br>';
                html += 'üí° PMI automatically drops off when you reach 20% equity. You can request removal once you reach 20% equity through payments or appreciation.';
                html += '</div>';
            }
            
            html += '</div>';
            document.getElementById('pmiInfoSection').innerHTML = html;
        }
        
        function displayPMIRedirectStrategy(principal, monthlyRate, maxPayments, basePI, pmiRemovalMonth, monthlyPMI, currentExtra, currentYearly, standardSchedule) {
            // Only show if PMI exists and will be removed before loan end
            if (monthlyPMI === 0 || pmiRemovalMonth === 0 || pmiRemovalMonth >= maxPayments) {
                document.getElementById('pmiRedirectSection').innerHTML = '';
                return;
            }
            
            // Calculate scenario where PMI payment is redirected to principal after PMI drops
            let balance = principal;
            let totalInterest = 0;
            let months = 0;
            
            while (balance > 0 && months < maxPayments) {
                months++;
                const interest = balance * monthlyRate;
                
                // After PMI drops, redirect that payment to principal
                const extraPayment = months > pmiRemovalMonth ? monthlyPMI : 0;
                let principalPayment = basePI + currentExtra + extraPayment - interest;
                
                // Add yearly extra
                if (months % 12 === 0) {
                    principalPayment += currentYearly;
                }
                
                if (principalPayment > balance) {
                    principalPayment = balance;
                }
                
                balance -= principalPayment;
                totalInterest += interest;
                if (balance <= 0) break;
            }
            
            // Compare to standard schedule
            const standardMonths = standardSchedule.length;
            const monthsSaved = standardMonths - months;
            const yearsSaved = Math.floor(monthsSaved / 12);
            const monthsRem = monthsSaved % 12;
            
            const standardInterest = standardSchedule.reduce((sum, p) => sum + p.interest, 0);
            const interestSaved = standardInterest - totalInterest;
            
            // Only show if there's meaningful savings
            if (monthsSaved < 6 || interestSaved < 1000) {
                document.getElementById('pmiRedirectSection').innerHTML = '';
                return;
            }
            
            const pmiDropDate = new Date(calculateFirstPaymentDate(document.getElementById('closingDate').value));
            pmiDropDate.setMonth(pmiDropDate.getMonth() + pmiRemovalMonth);
            
            const newPayoffDate = new Date(calculateFirstPaymentDate(document.getElementById('closingDate').value));
            newPayoffDate.setMonth(newPayoffDate.getMonth() + months);
            
            let html = '<div class="section">';
            html += '<div class="section-title">üí° Smart Strategy: Keep Paying the Same After PMI Drops</div>';
            html += '<div class="success-box">';
            html += '<strong>Here\'s a smart move most people miss:</strong><br><br>';
            html += 'When your PMI drops off in <strong>' + formatDate(pmiDropDate) + '</strong>, don\'t pocket the savings! ';
            html += 'Instead, keep paying the same amount you\'re used to‚Äîjust redirect that <strong>' + formatCurrency(monthlyPMI) + '</strong> to your principal.<br><br>';
            
            html += '<div style="background: white; padding: 20px; border-radius: 8px; margin-top: 15px;">';
            html += '<div style="text-align: center; margin-bottom: 20px;">';
            html += '<div style="font-size: 1.8em; font-weight: 700; color: #48bb78; margin-bottom: 5px;">';
            html += formatCurrency(interestSaved);
            html += '</div>';
            html += '<div style="color: #4a5568;">Additional Interest Saved</div>';
            html += '</div>';
            
            html += '<div class="comparison-grid" style="margin-top: 20px;">';
            
            // Pocket the savings scenario
            html += '<div class="comparison-card">';
            html += '<div class="comparison-title">üòä If You Pocket the Savings</div>';
            html += '<div class="comparison-item">';
            html += '<span class="comparison-label">After PMI Drops:</span>';
            html += '<span class="comparison-value">Pay ' + formatCurrency(basePI + currentExtra) + '/mo</span>';
            html += '</div>';
            html += '<div class="comparison-item">';
            html += '<span class="comparison-label">Payoff Date:</span>';
            html += '<span class="comparison-value">' + formatDate(new Date(calculateFirstPaymentDate(document.getElementById('closingDate').value).getTime() + standardMonths * 30 * 24 * 60 * 60 * 1000)) + '</span>';
            html += '</div>';
            html += '<div class="comparison-item">';
            html += '<span class="comparison-label">Total Interest:</span>';
            html += '<span class="comparison-value">' + formatCurrency(standardInterest) + '</span>';
            html += '</div>';
            html += '</div>';
            
            // Keep paying the same scenario
            html += '<div class="comparison-card success">';
            html += '<div class="comparison-title">üöÄ If You Keep Paying the Same</div>';
            html += '<div class="comparison-item">';
            html += '<span class="comparison-label">After PMI Drops:</span>';
            html += '<span class="comparison-value">Keep paying ' + formatCurrency(basePI + currentExtra + monthlyPMI) + '/mo</span>';
            html += '</div>';
            html += '<div class="comparison-item">';
            html += '<span class="comparison-label">Payoff Date:</span>';
            html += '<span class="comparison-value">' + formatDate(newPayoffDate) + '</span>';
            html += '</div>';
            html += '<div class="comparison-item">';
            html += '<span class="comparison-label">Total Interest:</span>';
            html += '<span class="comparison-value">' + formatCurrency(totalInterest) + '</span>';
            html += '</div>';
            html += '<div class="savings-highlight">';
            html += 'Pay off ';
            if (yearsSaved > 0) html += yearsSaved + ' year' + (yearsSaved > 1 ? 's' : '');
            if (monthsRem > 0) html += (yearsSaved > 0 ? ' ' : '') + monthsRem + ' month' + (monthsRem > 1 ? 's' : '');
            html += ' early!';
            html += '</div>';
            html += '</div>';
            
            html += '</div>'; // end comparison-grid
            
            html += '<div style="margin-top: 15px; padding: 15px; background: #f7fafc; border-radius: 8px; font-size: 0.95em;">';
            html += '<strong>Why this works:</strong> You\'re already budgeting for that payment. When PMI drops, you won\'t miss the money since you\'re used to paying it. But redirecting it to principal accelerates your payoff dramatically!';
            html += '</div>';
            
            html += '</div>'; // end white div
            html += '</div>'; // end success-box
            html += '</div>'; // end section
            
            document.getElementById('pmiRedirectSection').innerHTML = html;
        }
        
        function displayFiveYearTip(principal, monthlyRate, numPayments, basePI, standardInterest, currentExtra, currentYearly) {
            const targetPayments = numPayments - 60;
            
            if (targetPayments <= 12) {
                document.getElementById('fiveYearSection').innerHTML = '';
                return;
            }
            
            // Binary search for extra payment needed (ON TOP of existing extras)
            let low = 0;
            let high = basePI * 2;
            let additionalExtra = 0;
            
            for (let i = 0; i < 100; i++) {
                const testExtra = (low + high) / 2;
                const totalExtra = currentExtra + testExtra;
                let balance = principal;
                let months = 0;
                
                while (balance > 0 && months < numPayments) {
                    months++;
                    const interest = balance * monthlyRate;
                    let principal = basePI + totalExtra - interest;
                    if (months % 12 === 0) principal += currentYearly;
                    if (principal > balance) principal = balance;
                    balance -= principal;
                    if (balance <= 0) break;
                }
                
                if (months > targetPayments) {
                    low = testExtra;
                } else {
                    high = testExtra;
                }
                additionalExtra = testExtra;
                if (Math.abs(months - targetPayments) <= 1) break;
            }
            
            // Calculate interest with this additional extra
            let balance = principal;
            let totalInterest = 0;
            let months = 0;
            const totalExtra = currentExtra + additionalExtra;
            
            while (balance > 0 && months < numPayments) {
                months++;
                const interest = balance * monthlyRate;
                let principalPmt = basePI + totalExtra - interest;
                if (months % 12 === 0) principalPmt += currentYearly;
                if (principalPmt > balance) principalPmt = balance;
                balance -= principalPmt;
                totalInterest += interest;
                if (balance <= 0) break;
            }
            
            const interestSaved = standardInterest - totalInterest;
            
            if (additionalExtra < 10 || additionalExtra > basePI * 0.8) {
                document.getElementById('fiveYearSection').innerHTML = '';
                return;
            }
            
            let html = '<div class="section">';
            html += '<div class="section-title">üéØ Quick Tip: Pay Off 5 Years Early</div>';
            html += '<div class="info-box">';
            html += '<strong>Want to own your home 5 years sooner?</strong><br><br>';
            
            if (currentExtra > 0) {
                html += 'You\'re already paying an extra ' + formatCurrency(currentExtra) + ' monthly. ';
                html += 'By adding just <strong>' + formatCurrency(additionalExtra) + ' more</strong> (total: ' + formatCurrency(totalExtra) + '), you could:<br><br>';
            } else {
                html += 'By adding just <strong>' + formatCurrency(additionalExtra) + '</strong> to your monthly payment, you could:<br><br>';
            }
            
            html += '‚Ä¢ Pay off your mortgage 5 years early<br>';
            html += '‚Ä¢ Save <strong>' + formatCurrency(interestSaved) + '</strong> in interest<br>';
            html += '‚Ä¢ Build equity faster<br><br>';
            html += '<em>Your new monthly payment would be: ' + formatCurrency(basePI + totalExtra) + '</em>';
            html += '</div>';
            html += '</div>';
            
            document.getElementById('fiveYearSection').innerHTML = html;
        }
        
        function compare15vs30(homePrice, downPayment, interestRate, propertyTax, homeInsurance, hoaFees, pmiRate, loanType) {
            const loanAmount = homePrice - downPayment;
            const downPaymentPercent = (downPayment / homePrice) * 100;
            
            const terms = [15, 30];
            const results = terms.map(term => {
                const monthlyRate = interestRate / 12;
                const numPayments = term * 12;
                const monthlyPI = loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / (Math.pow(1 + monthlyRate, numPayments) - 1);
                
                let monthlyPMI = 0;
                if (loanType === 'fha') {
                    monthlyPMI = (loanAmount * pmiRate) / 12;
                } else if (downPaymentPercent < 20) {
                    monthlyPMI = (loanAmount * pmiRate) / 12;
                }
                
                const totalPayment = monthlyPI + (propertyTax / 12) + (homeInsurance / 12) + hoaFees + monthlyPMI;
                const totalPaid = monthlyPI * numPayments;
                const totalInterest = totalPaid - loanAmount;
                
                return {
                    term: term,
                    monthlyPayment: totalPayment,
                    totalInterest: totalInterest
                };
            });
            
            const interestDiff = results[1].totalInterest - results[0].totalInterest;
            const paymentDiff = results[0].monthlyPayment - results[1].monthlyPayment;
            const percentSavings = ((interestDiff / results[1].totalInterest) * 100).toFixed(0);
            
            let html = '<div class="section">';
            html += '<div class="section-title">15-Year vs 30-Year Comparison</div>';
            html += '<div class="comparison-grid">';
            
            results.forEach((result, index) => {
                const is15Year = index === 0;
                html += '<div class="comparison-card' + (is15Year ? ' success' : '') + '">';
                html += '<div class="comparison-title">' + result.term + '-Year Loan</div>';
                
                if (is15Year) {
                    html += '<div style="background: #48bb78; color: white; padding: 10px; border-radius: 6px; margin-bottom: 15px; text-align: center; font-weight: 600;">';
                    html += 'üí∞ Save ' + formatCurrency(interestDiff) + ' in Interest!';
                    html += '</div>';
                }
                
                html += '<div class="comparison-item">';
                html += '<span class="comparison-label">Monthly Payment:</span>';
                html += '<span class="comparison-value">' + formatCurrency(result.monthlyPayment) + '</span>';
                html += '</div>';
                html += '<div class="comparison-item">';
                html += '<span class="comparison-label">Total Interest:</span>';
                html += '<span class="comparison-value">' + formatCurrency(result.totalInterest) + '</span>';
                html += '</div>';
                html += '</div>';
            });
            
            html += '</div>';
            
            html += '<div class="info-box" style="margin-top: 20px;">';
            html += '<strong>üìä The Big Picture:</strong><br><br>';
            html += '‚Ä¢ <strong>15-Year:</strong> Pay ' + formatCurrency(paymentDiff) + ' MORE per month, save ' + percentSavings + '% in interest<br>';
            html += '‚Ä¢ <strong>30-Year:</strong> Lower payment, more flexibility, but costs more long-term<br><br>';
            html += '<strong>üí° Pro tip:</strong> Get a 30-year loan and make extra payments for the best of both worlds!';
            html += '</div>';
            html += '</div>';
            
            document.getElementById('loanComparisonSection').innerHTML = html;
        }
        
        function calculateClosingCosts(loanAmount, homePrice, propertyTax, homeInsurance, downPayment, loanType) {
            const originationFee = loanAmount * 0.01;
            const titleInsurance = homePrice * 0.005;
            const prepaidTax = propertyTax / 2;
            const prepaidInsurance = homeInsurance;
            const fhaUpfrontMIP = loanType === 'fha' ? loanAmount * 0.0175 : 0;
            
            const totalClosingCosts = originationFee + 500 + 50 + titleInsurance + 800 + 450 + 200 + prepaidTax + prepaidInsurance + fhaUpfrontMIP;
            const cashNeeded = downPayment + totalClosingCosts;
            
            let html = '<div class="section-title">Closing Costs in Maine</div>';
            html += '<div class="cost-row">';
            html += '<span class="cost-label">Loan Origination Fee (1%)</span>';
            html += '<span class="cost-value">' + formatCurrency(originationFee) + '</span>';
            html += '</div>';
            html += '<div class="cost-row">';
            html += '<span class="cost-label">Appraisal Fee</span>';
            html += '<span class="cost-value">$500</span>';
            html += '</div>';
            html += '<div class="cost-row">';
            html += '<span class="cost-label">Credit Report</span>';
            html += '<span class="cost-value">$50</span>';
            html += '</div>';
            html += '<div class="cost-row">';
            html += '<span class="cost-label">Title Search & Insurance</span>';
            html += '<span class="cost-value">' + formatCurrency(titleInsurance) + '</span>';
            html += '</div>';
            html += '<div class="cost-row">';
            html += '<span class="cost-label">Attorney Fees</span>';
            html += '<span class="cost-value">$800</span>';
            html += '</div>';
            html += '<div class="cost-row">';
            html += '<span class="cost-label">Home Inspection</span>';
            html += '<span class="cost-value">$450</span>';
            html += '</div>';
            html += '<div class="cost-row">';
            html += '<span class="cost-label">Recording Fees</span>';
            html += '<span class="cost-value">$200</span>';
            html += '</div>';
            
            if (loanType === 'fha') {
                html += '<div class="cost-row">';
                html += '<span class="cost-label">FHA Upfront Mortgage Insurance (1.75%)</span>';
                html += '<span class="cost-value">' + formatCurrency(fhaUpfrontMIP) + '</span>';
                html += '</div>';
            }
            
            html += '<div class="cost-row">';
            html += '<span class="cost-label">Prepaid Property Tax (6 months)</span>';
            html += '<span class="cost-value">' + formatCurrency(prepaidTax) + '</span>';
            html += '</div>';
            html += '<div class="cost-row">';
            html += '<span class="cost-label">Prepaid Insurance (1 year)</span>';
            html += '<span class="cost-value">' + formatCurrency(prepaidInsurance) + '</span>';
            html += '</div>';
            html += '<div class="cost-row cost-total">';
            html += '<span class="cost-label">Total Closing Costs:</span>';
            html += '<span class="cost-value">' + formatCurrency(totalClosingCosts) + '</span>';
            html += '</div>';
            html += '<div class="cost-row cost-total">';
            html += '<span class="cost-label">Cash Needed at Closing:</span>';
            html += '<span class="cost-value">' + formatCurrency(cashNeeded) + '</span>';
            html += '</div>';
            
            document.getElementById('closingCostsSection').innerHTML = html;
        }
        
        function createPaymentChart(pi, tax, ins, hoa, pmi, extra) {
            const ctx = document.getElementById('paymentChart').getContext('2d');
            if (paymentChart) paymentChart.destroy();
            
            const labels = ['Principal & Interest', 'Property Tax', 'Insurance', 'HOA', 'PMI/MIP', 'Extra Payment'];
            const data = [pi, tax, ins, hoa, pmi, extra];
            const colors = ['#4299e1', '#48bb78', '#ed8936', '#9f7aea', '#f56565', '#38b2ac'];
            
            const filteredLabels = [];
            const filteredData = [];
            const filteredColors = [];
            
            for (let i = 0; i < data.length; i++) {
                if (data[i] > 0) {
                    filteredLabels.push(labels[i]);
                    filteredData.push(data[i]);
                    filteredColors.push(colors[i]);
                }
            }
            
            paymentChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: filteredLabels,
                    datasets: [{
                        data: filteredData,
                        backgroundColor: filteredColors
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { padding: 15, font: { size: 13 } }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + formatCurrency(context.parsed);
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function createPrincipalInterestChart(schedule) {
            const ctx = document.getElementById('principalInterestChart').getContext('2d');
            if (principalInterestChart) principalInterestChart.destroy();
            
            const labels = [];
            const principalData = [];
            const interestData = [];
            
            for (let i = 0; i < schedule.length; i += 12) {
                labels.push('Year ' + Math.floor(i / 12 + 1));
                const yearData = schedule.slice(i, Math.min(i + 12, schedule.length));
                principalData.push(yearData.reduce((sum, p) => sum + p.principal, 0));
                interestData.push(yearData.reduce((sum, p) => sum + p.interest, 0));
            }
            
            principalInterestChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Principal', data: principalData, backgroundColor: '#4299e1' },
                        { label: 'Interest', data: interestData, backgroundColor: '#ed8936' }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: { stacked: true, grid: { display: false } },
                        y: {
                            stacked: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000).toFixed(0) + 'k';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: { position: 'bottom', labels: { padding: 15 } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function displayAmortizationTable(schedule) {
            const tbody = document.getElementById('amortizationBody');
            tbody.innerHTML = '';
            
            const showCount = Math.min(60, schedule.length);
            const lastYear = Math.max(0, schedule.length - 12);
            
            for (let i = 0; i < schedule.length; i++) {
                if (i < showCount || i >= lastYear || schedule[i].pmiRemoved) {
                    const row = tbody.insertRow();
                    if (schedule[i].pmiRemoved) row.className = 'pmi-removal';
                    
                    row.insertCell(0).textContent = schedule[i].month;
                    row.insertCell(1).textContent = formatCurrency(schedule[i].payment);
                    row.insertCell(2).textContent = formatCurrency(schedule[i].principal);
                    row.insertCell(3).textContent = formatCurrency(schedule[i].interest);
                    row.insertCell(4).textContent = schedule[i].pmi > 0 ? formatCurrency(schedule[i].pmi) : (schedule[i].pmiRemoved ? '‚úì Removed' : '-');
                    row.insertCell(5).textContent = formatCurrency(schedule[i].balance);
                }
                
                if (i === showCount - 1 && schedule.length > showCount + 12) {
                    const spacerRow = tbody.insertRow();
                    const cell = spacerRow.insertCell(0);
                    cell.colSpan = 6;
                    cell.textContent = '... (months ' + (showCount + 1) + ' through ' + lastYear + ') ...';
                    cell.style.textAlign = 'center';
                    cell.style.fontStyle = 'italic';
                    cell.style.color = '#718096';
                }
            }
            
            // Add summary totals
            const totalPayments = schedule.reduce((sum, p) => sum + p.payment, 0);
            const totalPrincipal = schedule.reduce((sum, p) => sum + p.principal, 0);
            const totalInterest = schedule.reduce((sum, p) => sum + p.interest, 0);
            const totalPMI = schedule.reduce((sum, p) => sum + p.pmi, 0);
            const totalPaid = totalPayments + (totalPMI * schedule.filter(p => p.pmi > 0).length);
            
            // Add a separator row
            const separatorRow = tbody.insertRow();
            separatorRow.style.background = '#e2e8f0';
            separatorRow.style.height = '3px';
            const sepCell = separatorRow.insertCell(0);
            sepCell.colSpan = 6;
            
            // Add totals row
            const totalsRow = tbody.insertRow();
            totalsRow.style.background = '#edf2f7';
            totalsRow.style.fontWeight = '700';
            totalsRow.style.fontSize = '1.05em';
            
            const labelCell = totalsRow.insertCell(0);
            labelCell.textContent = 'TOTALS:';
            labelCell.style.textAlign = 'left';
            
            totalsRow.insertCell(1).textContent = formatCurrency(totalPayments);
            totalsRow.insertCell(2).textContent = formatCurrency(totalPrincipal);
            totalsRow.insertCell(3).textContent = formatCurrency(totalInterest);
            totalsRow.insertCell(4).textContent = totalPMI > 0 ? formatCurrency(totalPMI) : '-';
            totalsRow.insertCell(5).textContent = formatCurrency(0);
            
            // Add summary section below table
            const tableWrapper = document.querySelector('.table-wrapper');
            
            // Remove existing summary if it exists
            const existingSummary = document.getElementById('scheduleSummary');
            if (existingSummary) {
                existingSummary.remove();
            }
            
            const summaryDiv = document.createElement('div');
            summaryDiv.id = 'scheduleSummary';
            summaryDiv.style.marginTop = '30px';
            summaryDiv.style.padding = '25px';
            summaryDiv.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            summaryDiv.style.borderRadius = '12px';
            summaryDiv.style.color = 'white';
            
            const homePrice = parseFloat(document.getElementById('homePrice').value);
            const downPayment = parseFloat(document.getElementById('downPayment').value);
            const totalCost = homePrice + totalInterest + totalPMI;
            
            summaryDiv.innerHTML = `
                <h3 style="font-size: 1.3em; margin-bottom: 20px; text-align: center;">üìä Complete Loan Summary</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                    <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; backdrop-filter: blur(10px);">
                        <div style="font-size: 0.85em; opacity: 0.9; margin-bottom: 5px;">Total Number of Payments</div>
                        <div style="font-size: 1.8em; font-weight: 700;">${schedule.length}</div>
                        <div style="font-size: 0.85em; opacity: 0.9; margin-top: 5px;">${(schedule.length / 12).toFixed(1)} years</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; backdrop-filter: blur(10px);">
                        <div style="font-size: 0.85em; opacity: 0.9; margin-bottom: 5px;">Total Principal Paid</div>
                        <div style="font-size: 1.8em; font-weight: 700;">${formatCurrency(totalPrincipal)}</div>
                        <div style="font-size: 0.85em; opacity: 0.9; margin-top: 5px;">Your loan amount</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; backdrop-filter: blur(10px);">
                        <div style="font-size: 0.85em; opacity: 0.9; margin-bottom: 5px;">Total Interest Paid</div>
                        <div style="font-size: 1.8em; font-weight: 700;">${formatCurrency(totalInterest)}</div>
                        <div style="font-size: 0.85em; opacity: 0.9; margin-top: 5px;">${((totalInterest / totalPrincipal) * 100).toFixed(0)}% of loan amount</div>
                    </div>
                    ${totalPMI > 0 ? `
                    <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; backdrop-filter: blur(10px);">
                        <div style="font-size: 0.85em; opacity: 0.9; margin-bottom: 5px;">Total PMI/MIP Paid</div>
                        <div style="font-size: 1.8em; font-weight: 700;">${formatCurrency(totalPMI)}</div>
                        <div style="font-size: 0.85em; opacity: 0.9; margin-top: 5px;">${schedule.filter(p => p.pmi > 0).length} months</div>
                    </div>
                    ` : ''}
                    <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; backdrop-filter: blur(10px);">
                        <div style="font-size: 0.85em; opacity: 0.9; margin-bottom: 5px;">Total Amount Paid</div>
                        <div style="font-size: 1.8em; font-weight: 700;">${formatCurrency(totalPayments + totalPMI)}</div>
                        <div style="font-size: 0.85em; opacity: 0.9; margin-top: 5px;">Principal + Interest + PMI</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; backdrop-filter: blur(10px);">
                        <div style="font-size: 0.85em; opacity: 0.9; margin-bottom: 5px;">True Cost of Home</div>
                        <div style="font-size: 1.8em; font-weight: 700;">${formatCurrency(totalCost)}</div>
                        <div style="font-size: 0.85em; opacity: 0.9; margin-top: 5px;">Purchase price + all interest/PMI</div>
                    </div>
                </div>
                <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.15); border-radius: 8px; text-align: center;">
                    <strong>Down Payment:</strong> ${formatCurrency(downPayment)} | 
                    <strong>Home Price:</strong> ${formatCurrency(homePrice)} | 
                    <strong>Interest Rate:</strong> ${document.getElementById('interestRate').value}%
                </div>
            `;
            
            tableWrapper.appendChild(summaryDiv);
        }
        
        function saveCalculation() {
            const data = {
                loanType: document.getElementById('loanType').value,
                closingDate: document.getElementById('closingDate').value,
                homePrice: document.getElementById('homePrice').value,
                downPayment: document.getElementById('downPayment').value,
                interestRate: document.getElementById('interestRate').value,
                loanTerm: document.getElementById('loanTerm').value,
                propertyTax: document.getElementById('propertyTax').value,
                homeInsurance: document.getElementById('homeInsurance').value,
                hoaFees: document.getElementById('hoaFees').value,
                pmiRate: document.getElementById('pmiRate').value,
                extraMonthly: document.getElementById('extraMonthly').value,
                extraYearly: document.getElementById('extraYearly').value,
                householdIncome: document.getElementById('householdIncome').value,
                savedDate: new Date().toLocaleDateString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'mortgage-calculation-' + new Date().toISOString().split('T')[0] + '.json';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
        
        function loadCalculation(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    document.getElementById('loanType').value = data.loanType || 'conventional';
                    document.getElementById('closingDate').value = data.closingDate || new Date().toISOString().split('T')[0];
                    document.getElementById('homePrice').value = data.homePrice || 300000;
                    document.getElementById('downPayment').value = data.downPayment || 60000;
                    document.getElementById('interestRate').value = data.interestRate || 6.5;
                    document.getElementById('loanTerm').value = data.loanTerm || 30;
                    document.getElementById('propertyTax').value = data.propertyTax || 3000;
                    document.getElementById('homeInsurance').value = data.homeInsurance || 1200;
                    document.getElementById('hoaFees').value = data.hoaFees || 0;
                    document.getElementById('pmiRate').value = data.pmiRate || 0.5;
                    document.getElementById('extraMonthly').value = data.extraMonthly || 0;
                    document.getElementById('extraYearly').value = data.extraYearly || 0;
                    document.getElementById('householdIncome').value = data.householdIncome || 0;
                    
                    updateDownPaymentPercent();
                    updateLoanTypeInfo();
                    calculate();
                } catch (error) {
                    alert('Sorry, there was a problem loading that file.');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }
        
        updateDownPaymentPercent();
        updateLoanTypeInfo();
    </script>
</body>
</html>
